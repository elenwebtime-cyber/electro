<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ó–∞–ø–∏—Å—å –Ω–∞ –≠–ª–µ–∫—Ç—Ä–æ—ç–ø–∏–ª—è—Ü–∏—é</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background-color: #0a0a0a; 
      color: white; 
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior: none; 
      user-select: none; 
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    input, textarea, select {
      user-select: auto; 
      -webkit-user-select: auto;
    }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .glass-card-dark { 
      background: rgba(30, 30, 30, 0.4); 
      backdrop-filter: blur(12px); 
      -webkit-backdrop-filter: blur(12px); 
    }
  </style>
  <script>
    // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ò–õ–ò –ë–†–û–ù–Æ –î–õ–Ø –°–ü–ê–°–ï–ù–ò–Ø –ê–ü–ü–ö–ò!
    // –ü–æ—Ç–æ–º —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
    // document.addEventListener('contextmenu', event => event.preventDefault());
    // document.addEventListener('keydown', event => {
    //   if (event.keyCode === 123 || 
    //      (event.ctrlKey && event.shiftKey && (event.keyCode === 73 || event.keyCode === 74)) || 
    //      (event.ctrlKey && event.keyCode === 85) || 
    //      (event.ctrlKey && event.keyCode === 67) || 
    //      (event.metaKey && event.altKey && event.keyCode === 73)) { 
    //       event.preventDefault();
    //   }
    // });
  </script>
</head>
<body class="bg-[#0a0a0a] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-[#0a0a0a] to-black font-sans selection:bg-[#C89D7C]/30">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // =========================================================================
    // ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò - –ó–ê–ü–û–õ–ù–ò–¢–ï –≠–¢–ò –ü–û–õ–Ø –°–í–û–ò–ú–ò –î–ê–ù–ù–´–ú–ò! ‚ö†Ô∏è
    // =========================================================================

    const ADMIN_TG_ID = 758556732; 
    
    const BOT_TOKEN_P1 = "8674902102:AAE"; 
    const BOT_TOKEN_P2 = "qbdZ8pbmFaq9Gx5UF8vXCbElTdNEIPzU"; 
    const BOT_TOKEN = BOT_TOKEN_P1 + BOT_TOKEN_P2;
    
    const CHAT_ID = "758556732"; 

    const FB_API_KEY_PART_1 = "AIzaSyDlDVoN"; 
    const FB_API_KEY_PART_2 = "dfA1TsrfvssVcAcXDxEktJtT28c"; 
    
    const firebaseConfig = {
      apiKey: FB_API_KEY_PART_1 + FB_API_KEY_PART_2,
      authDomain: "electro-6335d.firebaseapp.com", 
      projectId: "electro-6335d", 
      storageBucket: "electro-6335d.firebasestorage.app", 
      messagingSenderId: "385798330790", 
      appId: "1:385798330790:web:4f35f12cf734d01bd51767" 
    };

    if (!firebase.apps.length && firebaseConfig.projectId !== "–í–ê–®_–ü–†–û–ï–ö–¢") {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.apps.length ? firebase.firestore() : null;

    // –§–∏–∫—Å –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å–µ—Ç–∏/VPN –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞
    if (db) {
      try {
        db.settings({ experimentalForceLongPolling: true });
      } catch(e) {}
    }

    // =========================================================================
    // –ü–û–î–£–®–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (ERROR BOUNDARY)
    // =========================================================================
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      componentDidCatch(error, errorInfo) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error, errorInfo);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-[100dvh] bg-[#0a0a0a] flex flex-col items-center justify-center p-6 text-center animate-[fadeIn_0.3s_ease-out]">
               <div className="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mb-6 border border-red-500/30">
                  <span className="text-4xl">‚ö†Ô∏è</span>
               </div>
               <h2 className="text-2xl font-bold text-white mb-2">–û–π! –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞</h2>
               <p className="text-sm text-gray-400 mb-8 max-w-[280px]">
                  –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ø–∞–ª –Ω–µ–≤–∏–¥–∏–º—ã–π —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏) –∏–ª–∏ –∫—Ä–∏–≤–∞—è —Å—Å—ã–ª–∫–∞. 
               </p>
               <button onClick={() => {
                  localStorage.removeItem('electroAppData');
                  window.location.reload();
               }} className="bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold py-4 px-8 rounded-2xl shadow-[0_5px_15px_rgba(200,157,124,0.3)] hover:opacity-90 transition-opacity">
                 –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –∏ –ø–æ—á–∏–Ω–∏—Ç—å
               </button>
               <p className="text-[10px] text-gray-600 mt-6 max-w-[250px]">
                  –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —É–¥–∞–ª–∏—Ç–µ —Å–ª–æ–º–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ masterData) –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–Ω–æ–≤–æ, –ø–µ—á–∞—Ç–∞—è —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.
               </p>
            </div>
          );
        }
        return this.props.children; 
      }
    }

    // =========================================================================

    const triggerHaptic = () => {
      try {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.selectionChanged();
        } else if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      } catch (e) { console.log(e); }
    };

    const Icon = ({ name, className }) => {
      const icons = {
        MapPin: <g><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></g>,
        Info: <g><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></g>,
        Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
        CheckCircle2: <g><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></g>,
        ChevronLeft: <g><path d="m15 18-6-6 6-6"/></g>,
        Heart: <g><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></g>,
        Sparkles: <g><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></g>,
        AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
        Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></g>
      };
      const style = name === 'Heart' ? { fill: 'currentColor' } : {};
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
          {icons[name]}
        </svg>
      );
    };

    // =========================================================================
    // –ö–ê–°–¢–û–ú–ù–´–ï –ü–†–ï–ú–ò–£–ú –ö–û–ú–ü–û–ù–ï–ù–¢–´
    // =========================================================================

    const GlassSelect = ({ value, options, onChange, placeholder, disabled }) => {
        const [isOpen, setIsOpen] = useState(false);
        const selectedLabel = options.find(o => o.value === value)?.label || value;

        return (
            <div className="flex-1 relative">
                <div onClick={(e) => { if(!disabled) { e.stopPropagation(); setIsOpen(true); } }} className={`w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#C89D7C] flex justify-between items-center cursor-pointer transition-colors ${disabled ? 'opacity-50' : 'hover:border-gray-500'}`}>
                    <span className="truncate">{selectedLabel || placeholder}</span>
                    <Icon name="ChevronLeft" className={`w-4 h-4 transition-transform -rotate-90 text-gray-400`} />
                </div>
                
                {isOpen && (
                    <div className="fixed inset-0 z-[120] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}>
                        <div onClick={e => e.stopPropagation()} className="w-full max-w-md bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-[#C89D7C]/30 rounded-t-3xl p-2 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] max-h-[60vh] flex flex-col animate-[slideInUp_0.3s_ease-out]">
                            <div className="flex justify-between items-center mb-2 mt-2 px-4">
                                <span className="text-gray-400 text-sm font-bold">{placeholder}</span>
                                <button onClick={() => setIsOpen(false)} className="w-8 h-8 bg-black/50 rounded-full text-white font-bold pb-1 flex items-center justify-center">√ó</button>
                            </div>
                            <div className="overflow-y-auto hide-scrollbar flex-1 pb-4 px-2 space-y-2 mt-2" style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                                {options.map(opt => (
                                    <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); triggerHaptic(); }} className={`p-4 rounded-xl text-center font-medium cursor-pointer transition-all ${value === opt.value ? 'bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black shadow-lg' : 'bg-[#2A2A2A] text-white hover:bg-[#333]'}`}>
                                        {opt.label}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const GlassTimePicker = ({ value, onChange, disabled }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [hour, setHour] = useState(value ? value.split(':')[0] : '14');
      const [minute, setMinute] = useState(value ? value.split(':')[1] : '00');
      
      const hours = Array.from({length: 13}, (_, i) => String(i + 9).padStart(2, '0'));
      const minutes = ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];

      const hourRef = useRef(null);
      const minRef = useRef(null);

      useEffect(() => {
        if (isOpen) {
            setHour(value ? value.split(':')[0] : '14');
            setMinute(value ? value.split(':')[1] : '00');
        }
      }, [isOpen, value]);

      useEffect(() => {
          if (isOpen && hourRef.current && minRef.current) {
              const hIdx = hours.indexOf(hour);
              const mIdx = minutes.indexOf(minute);
              setTimeout(() => {
                  if(hourRef.current) hourRef.current.scrollTop = (hIdx !== -1 ? hIdx : 0) * 50;
                  if(minRef.current) minRef.current.scrollTop = (mIdx !== -1 ? mIdx : 0) * 50;
              }, 10);
          }
      }, [isOpen]);

      const handleScroll = (ref, arr, setter) => {
          if (!ref.current) return;
          const idx = Math.round(ref.current.scrollTop / 50);
          if (arr[idx]) setter(arr[idx]);
      };

      return (
        <div className="flex-1 relative">
          <div onClick={(e) => { if(!disabled) { e.stopPropagation(); setIsOpen(true); } }} className={`w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#C89D7C] flex justify-between items-center cursor-pointer transition-colors ${disabled ? 'opacity-50' : 'hover:border-gray-500'}`}>
            <span className="truncate">{value || '–í—Ä–µ–º—è...'}</span>
            <Icon name="Clock" className="w-4 h-4 text-gray-400" />
          </div>
          
          {isOpen && (
            <div className="fixed inset-0 z-[120] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}>
              <div onClick={e => e.stopPropagation()} className="w-full max-w-md bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-[#C89D7C]/30 rounded-t-3xl p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] animate-[slideInUp_0.3s_ease-out]">
                <div className="flex justify-between items-center mb-6">
                  <button onClick={() => { setIsOpen(false); triggerHaptic(); }} className="text-gray-400 font-medium px-2 py-1">–û—Ç–º–µ–Ω–∞</button>
                  <h3 className="text-white font-bold text-lg">–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏</h3>
                  <button onClick={() => { onChange(`${hour}:${minute}`); setIsOpen(false); triggerHaptic(); }} className="text-[#C89D7C] font-bold px-2 py-1">–ì–æ—Ç–æ–≤–æ</button>
                </div>
                
                <div className="flex justify-center gap-4 relative h-[150px] mb-4">
                  <div className="absolute top-1/2 -translate-y-1/2 left-4 right-4 h-[50px] bg-white/5 border-y border-[#C89D7C]/30 rounded-lg pointer-events-none z-0"></div>
                  
                  <div className="w-24 h-full overflow-y-auto hide-scrollbar snap-y snap-mandatory relative z-10" ref={hourRef} onScroll={() => handleScroll(hourRef, hours, setHour)} style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                    <div className="h-[50px]"></div>
                    {hours.map(h => (
                      <div key={h} className={`h-[50px] flex items-center justify-center snap-center text-3xl font-bold transition-colors ${hour === h ? 'text-[#C89D7C]' : 'text-gray-600'}`}>{h}</div>
                    ))}
                    <div className="h-[50px]"></div>
                  </div>
                  
                  <div className="flex items-center justify-center text-3xl font-bold text-white z-10 h-full pb-1">:</div>
                  
                  <div className="w-24 h-full overflow-y-auto hide-scrollbar snap-y snap-mandatory relative z-10" ref={minRef} onScroll={() => handleScroll(minRef, minutes, setMinute)} style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                    <div className="h-[50px]"></div>
                    {minutes.map(m => (
                      <div key={m} className={`h-[50px] flex items-center justify-center snap-center text-3xl font-bold transition-colors ${minute === m ? 'text-[#C89D7C]' : 'text-gray-600'}`}>{m}</div>
                    ))}
                    <div className="h-[50px]"></div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const GlassDurationPicker = ({ value, onChange, disabled }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [mins, setMins] = useState(value || 30);
      const durations = Array.from({length: 36}, (_, i) => (i + 1) * 10); // 10, 20 ... 360

      const listRef = useRef(null);

      useEffect(() => {
        if (isOpen) {
            setMins(value || 30);
        }
      }, [isOpen, value]);

      useEffect(() => {
          if (isOpen && listRef.current) {
              const idx = durations.indexOf(mins);
              setTimeout(() => {
                  if(listRef.current) listRef.current.scrollTop = (idx !== -1 ? idx : 0) * 50;
              }, 10);
          }
      }, [isOpen]);

      const handleScroll = () => {
          if (!listRef.current) return;
          const idx = Math.round(listRef.current.scrollTop / 50);
          if (durations[idx]) setMins(durations[idx]);
      };

      return (
        <div className="relative">
          <div onClick={(e) => { if(!disabled) { e.stopPropagation(); setIsOpen(true); } }} className={`w-24 bg-[#2A2A2A] border border-gray-700 rounded-xl p-1.5 text-white text-sm focus:outline-none focus:border-[#C89D7C] flex justify-between items-center cursor-pointer transition-colors ${disabled ? 'opacity-50' : 'hover:border-gray-500'}`}>
            <span className="truncate pl-1 font-medium">{value ? `${value} –º–∏–Ω` : '–í—Ä–µ–º—è'}</span>
            <Icon name="ChevronLeft" className="w-3 h-3 -rotate-90 text-gray-400 mr-1" />
          </div>
          
          {isOpen && (
            <div className="fixed inset-0 z-[120] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}>
              <div onClick={e => e.stopPropagation()} className="w-full max-w-md bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-[#C89D7C]/30 rounded-t-3xl p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] animate-[slideInUp_0.3s_ease-out]">
                <div className="flex justify-between items-center mb-6">
                  <button onClick={() => { setIsOpen(false); triggerHaptic(); }} className="text-gray-400 font-medium px-2 py-1">–û—Ç–º–µ–Ω–∞</button>
                  <h3 className="text-white font-bold text-lg">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                  <button onClick={() => { onChange(mins); setIsOpen(false); triggerHaptic(); }} className="text-[#C89D7C] font-bold px-2 py-1">–ì–æ—Ç–æ–≤–æ</button>
                </div>
                
                <div className="flex justify-center relative h-[150px] mb-4">
                  <div className="absolute top-1/2 -translate-y-1/2 left-10 right-10 h-[50px] bg-white/5 border-y border-[#C89D7C]/30 rounded-lg pointer-events-none z-0"></div>
                  
                  <div className="w-32 h-full overflow-y-auto hide-scrollbar snap-y snap-mandatory relative z-10" ref={listRef} onScroll={handleScroll} style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                    <div className="h-[50px]"></div>
                    {durations.map(d => (
                      <div key={d} className={`h-[50px] flex items-center justify-center snap-center text-3xl font-bold transition-colors ${mins === d ? 'text-[#C89D7C]' : 'text-gray-600'}`}>
                        {d}
                      </div>
                    ))}
                    <div className="h-[50px]"></div>
                  </div>
                  <div className="flex items-center justify-center text-lg font-medium text-gray-500 z-10 h-full pl-2 pointer-events-none">–º–∏–Ω</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // =========================================================================

    const generateCalendarDays = () => {
      const days = [];
      const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
      const weekDays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const today = new Date();
      for(let i=0; i<42; i++) {
         const d = new Date(today);
         d.setDate(today.getDate() + i);
         days.push({
           date: `${d.getDate()} ${months[d.getMonth()]}`,
           day: weekDays[d.getDay()]
         });
      }
      return days;
    };
    const globalCalendarDays = generateCalendarDays();
    const dateOptions = globalCalendarDays.map(d => ({ value: d.date, label: d.date }));
    const defaultSlots = ['10:00', '11:30', '14:00', '16:00', '18:30'];

    const initialMasterData = {
      name: "–¢–≤–æ–µ –ò–º—è",
      profession: "–ú–∞—Å—Ç–µ—Ä —ç–ª–µ–∫—Ç—Ä–æ—ç–ø–∏–ª—è—Ü–∏–∏",
      photoUrl: "https://images.unsplash.com/photo-1616683693504-3ea7e9ad6fec?q=80&w=200&auto=format&fit=crop",
      address: "–£—é—Ç–Ω–∞—è —Å—Ç—É–¥–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ (–º. –ö–∏—Ç–∞–π-–≥–æ—Ä–æ–¥)",
      addressNote: "–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –ø—Ä–∏—à–ª—é –∑–∞ –¥–µ–Ω—å –¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã ü§´",
      mapLink: "", 
      pricePerMinute: 40,
      about: "–£–¥–∞–ª—è—é –≤–æ–ª–æ—Å—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –†–∞–±–æ—Ç–∞—é –±–µ—Ä–µ–∂–Ω–æ, —Å—Ç–µ—Ä–∏–ª—å–Ω–æ –∏ —Å –ª—é–±–æ–≤—å—é –∫ —Ç–≤–æ–µ–º—É —Ç–µ–ª—É. ‚ú®",
      stories: [
        { id: 'st1', name: '–û—Ç–∑—ã–≤—ã', type: 'reviews', content: '', images: [] },
        { id: 'st2', name: '–î–æ/–ü–æ—Å–ª–µ', type: 'gallery', content: '', images: ['https://images.unsplash.com/photo-1512496015851-a1fbbfc614d3?q=80&w=400', 'https://images.unsplash.com/photo-1616683693504-3ea7e9ad6fec?q=80&w=400'] },
        { id: 'st3', name: '–ü—Ä–∞–π—Å', type: 'page', content: '–ú–∞–ª–∞—è –∑–æ–Ω–∞: 500‚ÇΩ\n–°—Ä–µ–¥–Ω—è—è –∑–æ–Ω–∞: 1000‚ÇΩ\n–ë–æ–ª—å—à–∞—è –∑–æ–Ω–∞: 2000‚ÇΩ', images: [] },
        { id: 'st4', name: '–ö–∞–±–∏–Ω–µ—Ç', type: 'insta', content: '', images: ['https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?q=80&w=400'] },
        { id: 'st5', name: '', type: 'insta', content: '', images: [] }
      ],
      memo: [
        "–î–ª–∏–Ω–∞ –≤–æ–ª–æ—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 5 –º–º.",
        "–ó–∞ —Å—É—Ç–∫–∏ –¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –Ω–µ –Ω–∞–Ω–æ—Å–∏—Ç—å –∫—Ä–µ–º—ã –∏ –º–∞—Å–ª–∞ –Ω–∞ –∑–æ–Ω—É.",
        "–ü—Ä–∏–º–∏ –¥—É—à –ø–µ—Ä–µ–¥ —Å–µ–∞–Ω—Å–æ–º.",
        "–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∞–Ω–µ—Å—Ç–µ–∑–∏—é (–∫—Ä–µ–º), –Ω–∞–Ω–µ—Å–∏ –ø–æ–¥ –ø–ª–µ–Ω–∫—É –∑–∞ 1.5 —á–∞—Å–∞ –¥–æ –∑–∞–ø–∏—Å–∏."
      ],
      services: [
        { id: 's1', name: '–õ–∏—Ü–æ (—É—Å–∏–∫–∏, –ø–æ–¥–±–æ—Ä–æ–¥–æ–∫)', defaultTime: 30, icon: '‚ú®' },
        { id: 's2', name: '–ü–æ–¥–º—ã—à–µ—á–Ω—ã–µ –≤–ø–∞–¥–∏–Ω—ã', defaultTime: 60, icon: 'üå∏' },
        { id: 's3', name: '–ë–∏–∫–∏–Ω–∏ –∫–ª–∞—Å—Å–∏–∫–∞', defaultTime: 120, icon: 'üëô' },
        { id: 's4', name: '–ì–æ–ª–µ–Ω–∏', defaultTime: 180, icon: 'ü¶µ' },
      ],
      addons: [
        { id: 'a1', name: '–ò–≥–æ–ª–æ—á–∫–∞-—ç–ª–µ–∫—Ç—Ä–æ–¥', price: 200, icon: 'ü™°' },
        { id: 'a2', name: '–ê–Ω–µ—Å—Ç–µ–∑–∏—è (–∫—Ä–µ–º/–≥–µ–ª—å)', price: 400, icon: 'üßä' }
      ],
      dates: [
        { date: globalCalendarDays[1].date, day: globalCalendarDays[1].day, slots: [...defaultSlots] },
        { date: globalCalendarDays[2].date, day: globalCalendarDays[2].day, slots: [...defaultSlots] },
        { date: globalCalendarDays[3].date, day: globalCalendarDays[3].day, slots: [...defaultSlots] }
      ],
      reviews: [
        { id: 'r1', name: '–ú–∞—Ä–∏—è', text: '–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –º–∞—Å—Ç–µ—Ä! –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ—à–ª–∞ –æ—á–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—É–ø–µ—Ä!', rating: 5, date: new Date().toISOString(), approved: true }
      ],
      clients: [] 
    };

    // ==========================================
    // –£–ú–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –ü–ï–†–ï–ö–†–´–í–ê–Æ–©–ò–•–°–Ø –°–õ–û–¢–û–í
    // ==========================================
    const removeOverlappingSlots = (slots, startTime, durationMins) => {
      const [h, m] = startTime.split(':').map(Number);
      const startMins = h * 60 + m;
      const endMins = startMins + durationMins;
      
      return slots.filter(time => {
          const [th, tm] = time.split(':').map(Number);
          const tMins = th * 60 + tm;
          return tMins < startMins || tMins >= endMins;
      });
    };

    function App() {
      const [appData, setAppData] = useState(() => {
        const saved = localStorage.getItem('electroAppData');
        let parsed = saved ? JSON.parse(saved) : initialMasterData;
        if (parsed.stories && parsed.stories.length > 0 && typeof parsed.stories[0] === 'string') {
          parsed.stories = parsed.stories.map((name, i) => ({
            id: 'st' + i, name: name, type: name.toLowerCase() === '–æ—Ç–∑—ã–≤—ã' ? 'reviews' : 'page', content: '', images: []
          }));
        }
        if (parsed.slots && Array.isArray(parsed.slots)) {
          parsed.dates = parsed.dates.map(d => ({ ...d, slots: d.slots ? d.slots : parsed.slots }));
          delete parsed.slots; 
        }
        if (parsed.dates) {
          parsed.dates = parsed.dates.map(d => ({...d, slots: d.slots || []}));
        }
        if (!parsed.clients) parsed.clients = [];
        return parsed;
      });

      const [isLoading, setIsLoading] = useState(!localStorage.getItem('electroAppData'));

      const [activeTab, setActiveTab] = useState('main'); 
      const [selectedServices, setSelectedServices] = useState([]);
      const [selectedDate, setSelectedDate] = useState(null);
      const [selectedTime, setSelectedTime] = useState(null);
      const [showMemo, setShowMemo] = useState(false);
      const [selectedDuration, setSelectedDuration] = useState(30); 
      const [selectedAddons, setSelectedAddons] = useState([]); 
      const [tapCount, setTapCount] = useState(0);
      const [clientPhone, setClientPhone] = useState(''); 
      const [dbConnected, setDbConnected] = useState(false);
      const [showAdminGear, setShowAdminGear] = useState(false);
      const [toastMsg, setToastMsg] = useState('');

      const [revName, setRevName] = useState('');
      const [revText, setRevText] = useState('');
      const [revRating, setRevRating] = useState('5');

      const [viewingStory, setViewingStory] = useState(null);
      const [storyImageIdx, setStoryImageIdx] = useState(0);

      // ==========================================
      // –°–û–°–¢–û–Ø–ù–ò–Ø –ê–î–ú–ò–ù–ö–ò 
      // ==========================================
      const [editData, setEditData] = useState(appData);
      const [adminSelectedDateObj, setAdminSelectedDateObj] = useState(null);
      const [newTimeVal, setNewTimeVal] = useState('');
      const [isSaving, setIsSaving] = useState(false);

      const [adminTab, setAdminTab] = useState('settings'); 
      const [adminSubView, setAdminSubView] = useState('main'); 
      
      const [bookingsList, setBookingsList] = useState([]);
      const [loadingBookings, setLoadingBookings] = useState(false);
      const [showManualBooking, setShowManualBooking] = useState(false);
      
      const [manualName, setManualName] = useState('');
      const [manualDate, setManualDate] = useState('');
      const [manualTime, setManualTime] = useState('');
      const [manualService, setManualService] = useState('');
      const [manualPhone, setManualPhone] = useState(''); 

      const [adminCalendarDate, setAdminCalendarDate] = useState(globalCalendarDays[0].date);
      const [calendarMonth, setCalendarMonth] = useState(new Date()); 
      const hoursList = Array.from({length: 13}, (_, i) => i + 9); 
      
      const [editingBooking, setEditingBooking] = useState(null);
      const [editBDate, setEditBDate] = useState('');
      const [editBTime, setEditBTime] = useState('');
      const [editBDuration, setEditBDuration] = useState(60);
      const [editBName, setEditBName] = useState(''); 
      const [editBServices, setEditBServices] = useState(''); // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–æ–Ω
      
      const [expandedClientTgId, setExpandedClientTgId] = useState(null);
      const [showAddClient, setShowAddClient] = useState(false);
      const [newClientName, setNewClientName] = useState('');
      const [newClientContact, setNewClientContact] = useState('');
      const [newClientPhone, setNewClientPhone] = useState(''); 
      const [clientSearch, setClientSearch] = useState(''); 
      // ==========================================

      let tapTimeout = useRef(null);

      const showToast = (msg) => {
        setToastMsg(msg);
        setTimeout(() => setToastMsg(''), 3000);
      };

      const fetchBookings = async () => {
        if (!db) return;
        setLoadingBookings(true);
        try {
          const snap = await db.collection("bookings").get();
          let b = [];
          snap.forEach(doc => b.push(doc.data()));
          setBookingsList(b);
        } catch(e) { console.error(e); }
        setLoadingBookings(false);
      };

      useEffect(() => {
        if (adminTab === 'calendar' || adminTab === 'clients') fetchBookings();
      }, [adminTab]);

      useEffect(() => {
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
          if (window.Telegram.WebApp.disableVerticalSwipes) {
              window.Telegram.WebApp.disableVerticalSwipes();
          }
        }

        if (db) {
          // –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          db.collection("settings").doc("masterData").get().then((doc) => {
            setDbConnected(true); 
            if (doc.exists) {
              let parsed = doc.data();
              if (parsed.stories && parsed.stories.length > 0 && typeof parsed.stories[0] === 'string') {
                parsed.stories = parsed.stories.map((name, i) => ({
                  id: 'st' + i, name: name, type: name.toLowerCase() === '–æ—Ç–∑—ã–≤—ã' ? 'reviews' : 'page', content: '', images: []
                }));
              }
              if (parsed.slots && Array.isArray(parsed.slots)) {
                parsed.dates = parsed.dates.map(d => ({ ...d, slots: d.slots ? d.slots : parsed.slots }));
                delete parsed.slots;
              }
              if (parsed.dates) {
                parsed.dates = parsed.dates.map(d => ({...d, slots: d.slots || []}));
              }
              if (parsed.mapLink === undefined) parsed.mapLink = "";
              
              // –ß–∏—Ç–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –Ω–æ–≤–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
              db.collection("clients").get().then((snap) => {
                 let cList = [];
                 snap.forEach(d => cList.push(d.data()));
                 
                 // –ï—Å–ª–∏ –Ω–æ–≤–∞—è –±–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç–∞—è, –±–µ—Ä–µ–º –∏—Ö –∏–∑ —Å—Ç–∞—Ä—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–º–∏–≥—Ä–∞—Ü–∏—è)
                 const finalClients = cList.length > 0 ? cList : (parsed.clients || []);
                 
                 const finalData = { ...parsed, clients: finalClients };
                 setAppData(finalData);
                 setEditData(finalData);
                 setIsLoading(false);
                 
                 // –ï—Å–ª–∏ –º—ã —Å–¥–µ–ª–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—é, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –ø–æ-–Ω–æ–≤–æ–º—É
                 if (cList.length === 0 && parsed.clients && parsed.clients.length > 0) {
                     parsed.clients.forEach(c => db.collection("clients").doc(String(c.tgId)).set(c).catch(console.error));
                 }
              }).catch(err => {
                 const finalData = { ...parsed, clients: parsed.clients || [] };
                 setAppData(finalData);
                 setEditData(finalData);
                 setIsLoading(false);
              });
            } else {
              setIsLoading(false);
            }
          }).catch(err => {
            setDbConnected(false); 
            console.error("Firebase load error:", err);
            setIsLoading(false);
          });
        } else {
          setDbConnected(false);
          setIsLoading(false);
        }
      }, []);

      const syncToFirebase = async (newData) => {
        if (db) {
          try {
            const dataToSave = { ...newData };
            // –ë–û–õ–¨–®–ï –ù–ï –°–û–•–†–ê–ù–Ø–ï–ú –ö–õ–ò–ï–ù–¢–û–í –í SETTINGS!
            delete dataToSave.clients; 
            await db.collection("settings").doc("masterData").set(dataToSave);
            setDbConnected(true);
          } catch (error) {
            console.error("Firebase sync error:", error);
            setDbConnected(false);
          }
        }
      };

      const saveClientToFirebase = (clientObj) => {
          if (db) db.collection("clients").doc(String(clientObj.tgId)).set(clientObj).catch(console.error);
      };

      const deleteClientFromFirebase = (tgId) => {
          if (db) db.collection("clients").doc(String(tgId)).delete().catch(console.error);
      };

      const handleNameClick = () => {
        if (tapTimeout.current) clearTimeout(tapTimeout.current);
        setTapCount(prev => {
          if (prev + 1 >= 5) {
            const userTgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (userTgId === ADMIN_TG_ID || !window.Telegram?.WebApp?.initDataUnsafe?.user) {
              setEditData(appData); 
              setShowAdminGear(true);
              triggerHaptic();
            } else {
              alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –í–∞—à TG ID: " + (userTgId || "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"));
            }
            return 0;
          }
          return prev + 1;
        });
        tapTimeout.current = setTimeout(() => setTapCount(0), 1000);
      };

      const toggleService = (service) => {
        triggerHaptic();
        let newServices;
        if (selectedServices.find(s => s.id === service.id)) {
          newServices = selectedServices.filter(s => s.id !== service.id);
        } else {
          newServices = [...selectedServices, service];
        }
        
        setSelectedServices(newServices);

        if (newServices.length > 0) {
          const suggestedTime = newServices.reduce((sum, s) => sum + parseInt(s.defaultTime), 0);
          setSelectedDuration(suggestedTime > 360 ? 360 : (suggestedTime < 30 ? 30 : suggestedTime)); 
        } else {
          setSelectedDuration(30);
        }
      };

      const toggleAddon = (addon) => {
        triggerHaptic();
        if (selectedAddons.find(a => a.id === addon.id)) {
          setSelectedAddons(selectedAddons.filter(a => a.id !== addon.id));
        } else {
          setSelectedAddons([...selectedAddons, addon]);
        }
      };

      const selectDateSlot = (dateObj) => { 
        triggerHaptic(); 
        setSelectedDate(dateObj.date); 
        setSelectedTime(null); 
      };
      
      const selectTimeSlot = (timeStr) => { 
          triggerHaptic(); 
          setSelectedTime(timeStr); 
      };

      const addonsPrice = selectedAddons.reduce((sum, addon) => sum + parseInt(addon.price), 0);
      const totalPrice = (selectedDuration * appData.pricePerMinute) + addonsPrice;

      const handlePreBooking = () => setShowMemo(true);

      const isUserBlacklisted = () => {
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        if (!tgUser.id) return false;
        const client = (appData.clients || []).find(c => c.tgId === tgUser.id);
        return client?.isBlacklisted || false;
      };

      const isExistingClient = () => {
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        if (!tgUser.id) return false;
        return (appData.clients || []).some(c => c.tgId === tgUser.id);
      };

      const handleFinalBooking = async () => {
        if (!isExistingClient() && (!clientPhone || !clientPhone.trim())) {
           alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!");
           return;
        }

        triggerHaptic();
        setShowMemo(false); 
        setActiveTab('success'); 

        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const clientName = tgUser.first_name ? `${tgUser.first_name} ${tgUser.last_name || ''}`.trim() : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç";
        const clientUsername = tgUser.username ? `(@${tgUser.username})` : "";
        const clientId = tgUser.id ? `(ID: ${tgUser.id})` : "";

        const servicesList = selectedServices.map(s => s.name).join(', ');
        const addonsList = selectedAddons.length > 0 ? `\n‚ûï –î–æ–ø—ã: ${selectedAddons.map(a => a.name).join(', ')}` : '';
        
        let updatedClients = [...(appData.clients || [])];
        let finalClientName = clientName;
        
        if (tgUser.id) {
            const cIdx = updatedClients.findIndex(c => c.tgId === tgUser.id);
            let finalClientObj;
            if (cIdx !== -1) {
                updatedClients[cIdx].visits = (updatedClients[cIdx].visits || 0) + 1;
                updatedClients[cIdx].username = clientUsername || updatedClients[cIdx].username;
                if (clientPhone) updatedClients[cIdx].phone = clientPhone;
                finalClientName = updatedClients[cIdx].customName || updatedClients[cIdx].originalName || clientName;
                finalClientObj = updatedClients[cIdx];
            } else {
                finalClientObj = {
                    tgId: tgUser.id,
                    originalName: clientName,
                    customName: '',
                    username: clientUsername,
                    phone: clientPhone,
                    visits: 1,
                    totalSpent: totalPrice,
                    isBlacklisted: false,
                    firstVisit: new Date().toISOString()
                };
                updatedClients.push(finalClientObj);
            }
            saveClientToFirebase(finalClientObj);
        }
        
        const messageToAdmin = `üî• *–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å!*\n\n` +
                        `üë§ –ö–ª–∏–µ–Ω—Ç: ${finalClientName} ${clientUsername} ${clientId}\n` +
                        (clientPhone ? `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${clientPhone}\n` : ``) +
                        `üìÖ ${selectedDate} –≤ ${selectedTime}\n` +
                        `üå∏ –ó–æ–Ω—ã: ${servicesList}${addonsList}\n` +
                        `‚è≥ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${selectedDuration} –º–∏–Ω\n` +
                        `üí∞ –û–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞: ~${totalPrice} ‚ÇΩ`;

        if (BOT_TOKEN && !BOT_TOKEN.includes("–í–ê–®_–¢–û–ö–ï–ù")) {
          try {
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chat_id: CHAT_ID,
                text: messageToAdmin,
                parse_mode: 'Markdown'
              })
            });
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω—É", error);
          }

          if (tgUser.id) {
            const messageToClient = `‚ú® *${finalClientName}, –≤–∞—à–∞ –∑–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!*\n\nüìÖ –î–∞—Ç–∞: ${selectedDate}\n‚è∞ –í—Ä–µ–º—è: ${selectedTime}\nüå∏ –ó–æ–Ω—ã: ${servicesList}${addonsList}\n‚è≥ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${selectedDuration} –º–∏–Ω\nüí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ~${totalPrice} ‚ÇΩ\n\nüìç –ê–¥—Ä–µ—Å: ${appData.address}\n_${appData.addressNote}_\n\n–ñ–¥—É –≤–∞—Å! ‚ù§Ô∏è`;
            try {
              await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  chat_id: tgUser.id,
                  text: messageToClient,
                  parse_mode: 'Markdown'
                })
              });
            } catch (error) {
              console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É", error);
            }
          }
        }

        const newBooking = {
          id: 'b' + Date.now(),
          date: selectedDate,
          time: selectedTime,
          clientName: finalClientName,
          clientContact: clientUsername || clientId || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
          phone: clientPhone,
          services: servicesList + addonsList,
          duration: selectedDuration,
          price: totalPrice,
          tgId: tgUser.id || null,
          createdAt: new Date().toISOString()
        };

        if (db) {
          db.collection("bookings").doc(newBooking.id).set(newBooking).catch(err => console.error("Firebase booking error:", err));
        }

        const updatedDates = [...appData.dates];
        const targetDateIdx = updatedDates.findIndex(d => d.date === selectedDate);
        if (targetDateIdx !== -1) {
          updatedDates[targetDateIdx].slots = removeOverlappingSlots(updatedDates[targetDateIdx].slots, selectedTime, selectedDuration);
          const newData = { ...appData, dates: updatedDates, clients: updatedClients };
          setAppData(newData);
          setEditData(newData);
          syncToFirebase(newData);
          localStorage.setItem('electroAppData', JSON.stringify(newData));
        }
      };

      const resetBooking = () => {
        triggerHaptic();
        setActiveTab('main');
        setSelectedServices([]);
        setSelectedDate(null);
        setSelectedTime(null);
        setSelectedDuration(30);
        setSelectedAddons([]);
        setClientPhone('');
      };

      const submitClientReview = () => {
        triggerHaptic();
        if (!revName.trim() || !revText.trim()) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
          return;
        }

        const newReview = {
          id: 'r' + Date.now(),
          name: revName.trim(),
          text: revText.trim(),
          rating: parseInt(revRating),
          date: new Date().toISOString(),
          approved: false 
        };

        const currentReviews = appData.reviews || [];
        const newData = { ...appData, reviews: [newReview, ...currentReviews] };
        
        setAppData(newData);
        setEditData(newData);
        syncToFirebase(newData);
        
        showToast("–°–ø–∞—Å–∏–±–æ! –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. üíñ");
        setRevName('');
        setRevText('');
        setRevRating('5');
      };

      const openStory = (story) => {
        triggerHaptic();
        if (!story.name.trim()) return;
        
        if (story.type === 'reviews') {
          setActiveTab('reviews');
        } else if (story.type === 'page') {
          setViewingStory(story);
          setActiveTab('story_page');
        } else {
          if(!story.images || story.images.length === 0) {
             alert("–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.");
             return;
          }
          setViewingStory(story);
          setStoryImageIdx(0);
        }
      };

      const renderMain = () => (
        <div className="pb-64 animate-[fadeIn_0.5s_ease-in-out]">
          <div className="flex flex-col items-center text-center mt-6 mb-8 relative">
            
            {showAdminGear && (
              <div onClick={() => { triggerHaptic(); setActiveTab('admin'); setShowAdminGear(false); }} 
                   className="absolute top-0 left-6 bg-[#1A1A1A] p-2.5 rounded-full border border-[#C89D7C] cursor-pointer shadow-[0_0_15px_rgba(200,157,124,0.4)] animate-[zoomIn_0.3s_ease-out] z-50">
                <Icon name="Settings" className="w-6 h-6 text-[#C89D7C] animate-[spin_3s_linear_infinite]" />
              </div>
            )}

            <div className="w-28 h-28 rounded-full bg-gradient-to-tr from-[#C89D7C] to-[#E8CDB5] p-1 shadow-[0_0_20px_rgba(200,157,124,0.3)] mb-4">
              <div className="w-full h-full rounded-full bg-[#121212] flex items-center justify-center overflow-hidden relative">
                <img src={appData.photoUrl} alt="Master" className="object-cover w-full h-full opacity-90" />
              </div>
            </div>
            <h1 onClick={handleNameClick} className="text-xl font-medium text-gray-100 tracking-[0.15em] uppercase cursor-pointer select-none drop-shadow-sm mt-2">
              {appData.name}
            </h1>
            <p className="text-[#C89D7C] font-medium mt-1">{appData.profession}</p>
          </div>

          <div className="flex justify-evenly w-full px-4 mb-6">
            {appData.stories.map((story, idx) => {
              if (!story.name.trim()) return null; 
              return (
                <div key={idx} onClick={() => openStory(story)} className="flex flex-col items-center gap-2">
                  <div className="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-gradient-to-tr from-[#754E33] to-[#E8CDB5] p-[1px] cursor-pointer hover:scale-105 transition-transform">
                    <div className="w-full h-full rounded-full bg-[#1A1A1A] flex items-center justify-center">
                      <Icon name="Sparkles" className="w-5 h-5 sm:w-6 sm:h-6 text-[#C89D7C]" />
                    </div>
                  </div>
                  <span className="text-[10px] sm:text-xs text-gray-400 font-medium whitespace-nowrap">{story.name}</span>
                </div>
              );
            })}
          </div>

          <div className="grid grid-cols-2 gap-3 px-4 mt-2">
            <div className="col-span-2 glass-card-dark p-4 rounded-3xl flex items-center justify-between border border-white/5">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-[#2A2A2A] flex items-center justify-center text-[#C89D7C] shrink-0">
                  <Icon name="MapPin" className="w-5 h-5" />
                </div>
                <div>
                  <p className="text-sm font-semibold text-gray-200">{appData.address}</p>
                  <p className="text-xs text-[#C89D7C] mt-0.5">{appData.addressNote}</p>
                </div>
              </div>
              {appData.mapLink && (
                <a href={appData.mapLink} target="_blank" rel="noopener noreferrer" onClick={triggerHaptic} className="bg-[#2A2A2A] px-3 h-8 rounded-full border border-[#C89D7C]/30 flex items-center justify-center gap-1.5 hover:bg-[#333] transition-colors shrink-0 ml-2">
                   <span className="text-[10px] font-bold text-[#C89D7C] whitespace-nowrap leading-none mt-[1px]">–ö–ê–†–¢–ê</span>
                   <Icon name="MapPin" className="w-3 h-3 text-[#C89D7C]" />
                </a>
              )}
            </div>

            <div className="col-span-2 glass-card-dark p-5 rounded-3xl border border-white/5">
              <div className="flex items-center gap-2 mb-2">
                <Icon name="Info" className="w-5 h-5 text-[#C89D7C]" />
                <h3 className="font-semibold text-gray-200">–û–±–æ –º–Ω–µ</h3>
              </div>
              <p className="text-sm text-gray-400 leading-relaxed whitespace-pre-wrap">{appData.about}</p>
            </div>

            <div className="col-span-2 mt-4">
              <div className="flex items-center justify-between mb-4 px-1">
                <h2 className="text-xl font-bold text-white tracking-wide">–í—ã–±–µ—Ä–∏ –∑–æ–Ω—ã</h2>
                <div className="bg-[#2A2A2A] px-3 h-7 rounded-full border border-[#C89D7C]/30 flex items-center justify-center">
                  <span className="text-xs font-bold text-[#C89D7C] whitespace-nowrap">{appData.pricePerMinute} ‚ÇΩ / –º–∏–Ω</span>
                </div>
              </div>

              <div className="flex flex-col gap-3">
                {appData.services.map(service => {
                  const isSelected = selectedServices.find(s => s.id === service.id);
                  return (
                    <div key={service.id} onClick={() => toggleService(service)} className={`glass-card-dark p-4 rounded-3xl cursor-pointer transition-all duration-300 border ${isSelected ? 'border-[#C89D7C] bg-[#C89D7C]/10' : 'border-white/5 hover:border-white/20'}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="text-2xl">{service.icon}</div>
                          <div>
                            <h3 className="font-semibold text-gray-200">{service.name}</h3>
                            <p className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                              <Icon name="Clock" className="w-3 h-3" /> ~ {service.defaultTime} –º–∏–Ω
                            </p>
                          </div>
                        </div>
                        <div className={`w-6 h-6 rounded-full border-2 ml-auto flex items-center justify-center transition-colors ${isSelected ? 'bg-[#C89D7C] border-[#C89D7C]' : 'border-gray-600'}`}>
                          {isSelected && <Icon name="CheckCircle2" className="w-4 h-4 text-black" />}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <h2 className="text-xl font-bold text-white tracking-wide mt-6 mb-4 px-1">–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?</h2>
              <div className="flex flex-col gap-3">
                {appData.addons.map(addon => {
                  const isSelected = selectedAddons.find(a => a.id === addon.id);
                  return (
                    <div key={addon.id} onClick={() => toggleAddon(addon)} className={`glass-card-dark p-4 rounded-3xl cursor-pointer transition-all duration-300 border ${isSelected ? 'border-[#C89D7C] bg-[#C89D7C]/10' : 'border-white/5 hover:border-white/20'}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="text-2xl">{addon.icon}</div>
                          <div>
                            <h3 className="font-semibold text-gray-200">{addon.name}</h3>
                            <p className="text-xs text-[#C89D7C] mt-0.5">+ {addon.price} ‚ÇΩ</p>
                          </div>
                        </div>
                        <div className={`w-6 h-6 rounded-full border-2 ml-auto flex items-center justify-center transition-colors ${isSelected ? 'bg-[#C89D7C] border-[#C89D7C]' : 'border-gray-600'}`}>
                          {isSelected && <Icon name="CheckCircle2" className="w-4 h-4 text-black" />}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );

      const renderStoryPage = () => (
        <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out] min-h-[100dvh] w-full">
          <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
            <Icon name="ChevronLeft" className="w-5 h-5" />
            <span className="font-medium">–ù–∞–∑–∞–¥</span>
          </button>
          <h2 className="text-2xl font-bold text-white mb-6 tracking-wide">{viewingStory?.name}</h2>
          <div className="glass-card-dark p-5 rounded-3xl border border-white/5 whitespace-pre-wrap text-sm text-gray-300 leading-relaxed min-h-[50vh]">
            {viewingStory?.content || "–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç."}
          </div>
        </div>
      );

      const renderBooking = () => {
        if (isUserBlacklisted()) {
          return (
             <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out]">
                <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
                  <Icon name="ChevronLeft" className="w-5 h-5" />
                  <span className="font-medium">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
                </button>
                <div className="glass-card-dark p-6 rounded-3xl text-center border border-white/10 mt-10">
                    <h3 className="text-xl font-bold text-white mb-2">–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –Ω–µ—Ç üòî</h3>
                    <p className="text-gray-400 text-sm">–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∑–∂–µ.</p>
                </div>
             </div>
          );
        }

        const availableSlotsForDate = appData.dates.find(d => d.date === selectedDate)?.slots || [];

        return (
          <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out]">
            <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
              <Icon name="ChevronLeft" className="w-5 h-5" />
              <span className="font-medium">–ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º</span>
            </button>

            <h2 className="text-2xl font-bold text-white mb-6 tracking-wide">–í—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è</h2>

            <div className="mb-8 relative">
              <div className="flex justify-between items-end mb-3">
                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã</h3>
                <div className="flex items-center gap-1 text-[#C89D7C] text-[10px] uppercase font-bold tracking-widest animate-pulse pr-1">
                  <span>–õ–∏—Å—Ç–∞–π</span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="rotate-180"><path d="m15 18-6-6 6-6"/></svg>
                </div>
              </div>
              
              <div className="flex gap-3 overflow-x-auto pb-2 hide-scrollbar">
                {appData.dates.map((item, idx) => (
                  <div key={idx} onClick={() => selectDateSlot(item)} className={`flex flex-col items-center justify-center min-w-[70px] h-20 rounded-2xl cursor-pointer transition-all border shrink-0 ${selectedDate === item.date ? 'bg-gradient-to-b from-[#C89D7C] to-[#9A6A45] text-black shadow-[0_5px_15px_rgba(200,157,124,0.3)] border-transparent' : 'glass-card-dark text-gray-300 border-white/5'}`}>
                    <span className="text-xs mb-1 opacity-80">{item.day}</span>
                    <span className="text-xl font-bold">{item.date.split(' ')[0]}</span>
                  </div>
                ))}
              </div>
            </div>

            {selectedDate && (
              <div className="animate-[fadeIn_0.5s_ease-out]">
                <h3 className="text-sm font-semibold text-gray-500 mb-3 uppercase tracking-wider">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏</h3>
                {availableSlotsForDate.length === 0 ? (
                  <p className="text-gray-400 text-sm">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫.</p>
                ) : (
                  <div className="grid grid-cols-3 gap-3">
                    {availableSlotsForDate.map((time, idx) => (
                      <div key={idx} onClick={() => selectTimeSlot(time)} className={`py-3 rounded-xl text-center font-medium cursor-pointer transition-all border ${selectedTime === time ? 'bg-[#2A2A2A] text-[#C89D7C] border-[#C89D7C] shadow-[0_0_10px_rgba(200,157,124,0.2)]' : 'glass-card-dark text-gray-400 border-white/5 hover:bg-white/5'}`}>
                        {time}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      const renderHearts = () => {
        return Array.from({ length: 25 }).map((_, i) => (
          <div key={i} className="absolute text-[#C89D7C] animate-[floatUp_linear_infinite]" 
               style={{
                 left: `${Math.random() * 100}%`,
                 animationDuration: `${Math.random() * 3 + 2}s`,
                 animationDelay: `${Math.random() * 2}s`,
                 fontSize: `${Math.random() * 15 + 10}px`,
                 opacity: 0.7
               }}>
            <Icon name="Heart" className="w-full h-full" />
          </div>
        ));
      };

      const renderSuccess = () => (
        <div className="relative px-4 h-screen flex flex-col items-center justify-center text-center animate-[zoomIn_0.5s_ease-out] overflow-hidden">
          <div className="absolute inset-0 z-0 pointer-events-none">{renderHearts()}</div>
          <div className="z-10 w-24 h-24 bg-[#C89D7C]/20 rounded-full flex items-center justify-center mb-6 border border-[#C89D7C]/50">
            <Icon name="Heart" className="w-12 h-12 text-[#C89D7C] animate-bounce" />
          </div>
          <h2 className="z-10 text-3xl font-bold text-white mb-2 shadow-black drop-shadow-lg">–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</h2>
          <p className="z-10 text-gray-300 mb-8 max-w-[250px] shadow-black drop-shadow-md">
            –ñ–¥—É —Ç–µ–±—è {selectedDate} –≤ {selectedTime}. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –∫ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ!
          </p>
          
          <div className="z-10 glass-card-dark p-6 rounded-3xl w-full text-left mb-8 border border-[#C89D7C]/30 shadow-2xl">
            <h4 className="font-semibold text-gray-200 mb-3">–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏:</h4>
            <ul className="space-y-2 mb-4">
              {selectedServices.map(s => (
                <li key={s.id} className="text-sm text-gray-300 flex justify-between">
                  <span>{s.icon} {s.name}</span>
                </li>
              ))}
              {selectedAddons.map(a => (
                <li key={a.id} className="text-sm text-[#C89D7C] flex justify-between">
                  <span>{a.icon} {a.name}</span>
                  <span className="font-medium">+ {a.price} ‚ÇΩ</span>
                </li>
              ))}
            </ul>
            <div className="pt-3 border-t border-gray-700 flex justify-between items-center mb-2">
              <span className="text-gray-400">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏:</span>
              <span className="font-medium text-gray-100">{selectedDuration} –º–∏–Ω</span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-gray-400">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
              <span className="text-xl font-bold text-[#C89D7C]">~ {totalPrice} ‚ÇΩ</span>
            </div>
          </div>

          <button onClick={resetBooking} className="z-10 w-full py-4 bg-[#2A2A2A] text-white rounded-2xl font-semibold shadow-lg border border-white/10 relative overflow-hidden group">
            <span className="relative z-10">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</span>
            <div className="absolute inset-0 bg-[#C89D7C]/20 w-0 group-hover:w-full transition-all duration-300"></div>
          </button>
        </div>
      );

      const renderMemoModal = () => (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-[fadeIn_0.3s_ease-out]">
          <div className="bg-[#1A1A1A] border border-[#C89D7C]/30 p-6 rounded-3xl w-full max-w-sm shadow-[0_0_40px_rgba(200,157,124,0.15)]">
            <div className="flex items-center gap-3 mb-4">
              <Icon name="AlertCircle" className="w-6 h-6 text-[#C89D7C]" />
              <h3 className="text-xl font-bold text-white">–í–∞–∂–Ω–æ –ø–µ—Ä–µ–¥ –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π!</h3>
            </div>
            <ul className="text-sm text-gray-300 space-y-3 mb-4 list-disc pl-5 marker:text-[#C89D7C]">
              {appData.memo.map((item, idx) => (
                <li key={idx}>{item}</li>
              ))}
            </ul>
            
            {!isExistingClient() && (
              <input 
                type="tel" 
                value={clientPhone} 
                onChange={e => setClientPhone(e.target.value)}
                placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                className="w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-3 text-white text-sm mb-6 focus:outline-none focus:border-[#C89D7C]"
              />
            )}
            
            <div className="flex gap-3">
              <button onClick={() => { triggerHaptic(); setShowMemo(false); }} className="flex-1 py-3 rounded-xl border border-gray-700 text-gray-400 font-medium hover:bg-gray-800 transition-colors">
                –ù–∞–∑–∞–¥
              </button>
              <button onClick={handleFinalBooking} className="flex-[2] py-3 rounded-xl bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold shadow-lg">
                –ü–æ–Ω—è–ª–∞, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
              </button>
            </div>
          </div>
        </div>
      );

      const renderReviews = () => {
        const approvedReviews = (appData.reviews || []).filter(r => r.approved).sort((a,b) => new Date(b.date) - new Date(a.date));

        return (
          <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out] min-h-[100dvh] w-full">
            <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
              <Icon name="ChevronLeft" className="w-5 h-5" />
              <span className="font-medium">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </button>

            <h2 className="text-2xl font-bold text-white mb-6 tracking-wide">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>

            {/* –ë–õ–û–ö –û–°–¢–ê–í–ò–¢–¨ –û–¢–ó–´–í (–ü–ï–†–ï–ù–ï–°–ï–ù –ù–ê–í–ï–†–•) */}
            <div className="glass-card-dark p-4 rounded-2xl border border-[#C89D7C]/20 relative overflow-hidden mb-8 shadow-sm">
              <div className="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-[#C89D7C] to-[#9A6A45]"></div>
              <h3 className="text-base font-bold text-white mb-3 text-center tracking-wide">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
              
              <div className="flex justify-center gap-2 mb-4">
                {[1, 2, 3, 4, 5].map(star => (
                  <span 
                    key={star} 
                    onClick={() => { triggerHaptic(); setRevRating(String(star)); }}
                    className={`text-3xl cursor-pointer transition-all ${parseInt(revRating) >= star ? 'text-[#C89D7C] drop-shadow-[0_0_8px_rgba(200,157,124,0.4)] scale-110' : 'text-gray-700 hover:text-gray-500'}`}
                  >
                    ‚òÖ
                  </span>
                ))}
              </div>

              <input 
                type="text" value={revName} onChange={e => setRevName(e.target.value)}
                placeholder="–¢–≤–æ–µ –∏–º—è" 
                className="w-full bg-black/30 border border-gray-700 rounded-lg p-2.5 text-white text-sm mb-2.5 focus:outline-none focus:border-[#C89D7C] transition-colors"
              />
              
              <textarea 
                value={revText} onChange={e => setRevText(e.target.value)}
                placeholder="–ü–æ–¥–µ–ª–∏—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏..." 
                rows="2" 
                className="w-full bg-black/30 border border-gray-700 rounded-lg p-2.5 text-white text-sm mb-4 focus:outline-none focus:border-[#C89D7C] transition-colors resize-none"
              ></textarea>

              <button onClick={submitClientReview} className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black py-2.5 rounded-lg font-bold shadow-md hover:opacity-90 transition-opacity text-sm uppercase tracking-wide">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
            </div>

            {/* –°–ü–ò–°–û–ö –û–¢–ó–´–í–û–í */}
            <div className="space-y-4 mb-8">
              {approvedReviews.length === 0 ? (
                <p className="text-gray-500 text-center py-6">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å –ø–µ—Ä–≤–æ–π!</p>
              ) : (
                approvedReviews.map(rev => (
                  <div key={rev.id} className="glass-card-dark p-5 rounded-3xl border border-white/5 relative overflow-hidden">
                    <div className="flex justify-between items-center mb-3">
                      <h4 className="font-bold text-white">{rev.name}</h4>
                      <div className="flex text-[#C89D7C] text-sm tracking-widest">
                        {'‚òÖ'.repeat(rev.rating)}{'‚òÜ'.repeat(5-rev.rating)}
                      </div>
                    </div>
                    <p className="text-sm text-gray-300 leading-relaxed mb-3">{rev.text}</p>
                    <div className="text-[10px] text-gray-500">{new Date(rev.date).toLocaleDateString('ru-RU')}</div>
                  </div>
                ))
              )}
            </div>

          </div>
        );
      };

      if (isLoading) {
        return (
          <div className="max-w-md mx-auto min-h-[100dvh] w-full flex flex-col items-center justify-center bg-[#0a0a0a] shadow-2xl border-x border-white/5 relative overflow-hidden">
             <div className="w-12 h-12 border-4 border-[#C89D7C]/20 border-t-[#C89D7C] rounded-full animate-spin mb-4"></div>
             <p className="text-[#C89D7C] text-xs font-bold tracking-[0.2em] animate-pulse">–ó–ê–ì–†–£–ó–ö–ê...</p>
          </div>
        );
      }

      return (
        <div className="max-w-md mx-auto min-h-[100dvh] w-full relative shadow-2xl bg-black/40 border-x border-white/5 overflow-hidden">
          
          {/* –¢–û–ß–ö–ê –°–¢–ê–¢–£–°–ê FIREBASE (–°–í–ï–¢–û–§–û–†) */}
          <div 
            className={`fixed top-4 right-4 w-2.5 h-2.5 rounded-full z-[60] transition-colors duration-500 ${dbConnected ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]'}`} 
            title={dbConnected ? "–û–±–ª–∞–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–ù–µ—Ç —Å–≤—è–∑–∏ —Å –æ–±–ª–∞–∫–æ–º"}
          ></div>

          {/* –í–°–ü–õ–´–í–ê–Æ–©–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (TOAST) */}
          {toastMsg && (
            <div className="fixed top-10 left-1/2 -translate-x-1/2 z-[100] bg-green-600/90 text-white px-6 py-3 rounded-full shadow-[0_5px_20px_rgba(34,197,94,0.4)] backdrop-blur-md font-bold text-sm animate-[fadeIn_0.3s_ease-out] border border-green-400/30 whitespace-nowrap">
              {toastMsg}
            </div>
          )}

          {activeTab === 'main' && renderMain()}
          {activeTab === 'booking' && renderBooking()}
          {activeTab === 'success' && renderSuccess()}
          {activeTab === 'admin' && renderAdminPanel()}
          {activeTab === 'reviews' && renderReviews()}
          {activeTab === 'story_page' && renderStoryPage()}

          {/* –í–°–ü–õ–´–í–ê–Æ–©–ê–Ø –ì–ê–õ–ï–†–ï–Ø (–ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û) */}
          {viewingStory && viewingStory.type === 'gallery' && (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-[fadeIn_0.3s_ease-out]">
              <div className="bg-[#1A1A1A] border border-[#C89D7C]/30 rounded-3xl w-full max-w-sm overflow-hidden relative shadow-2xl">
                <button onClick={() => { triggerHaptic(); setViewingStory(null); }} className="absolute top-3 right-3 z-10 w-8 h-8 bg-black/50 rounded-full text-white flex items-center justify-center font-bold text-xl pb-1">√ó</button>
                <div className="w-full aspect-[3/4] max-h-[70vh] bg-black relative">
                  {viewingStory.images[storyImageIdx] ? (
                    <img src={viewingStory.images[storyImageIdx]} className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-500">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                  )}
                  {storyImageIdx > 0 && (
                    <button onClick={() => { triggerHaptic(); setStoryImageIdx(prev=>prev-1); }} className="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center font-bold">‚Äπ</button>
                  )}
                  {storyImageIdx < viewingStory.images.length - 1 && (
                    <button onClick={() => { triggerHaptic(); setStoryImageIdx(prev=>prev+1); }} className="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center font-bold">‚Ä∫</button>
                  )}
                </div>
                <div className="p-4 text-center">
                  <h3 className="font-bold text-white mb-1">{viewingStory.name}</h3>
                  <p className="text-xs text-gray-400">{storyImageIdx + 1} / {viewingStory.images.length || 0}</p>
                </div>
              </div>
            </div>
          )}

          {/* –ò–ù–°–¢–ê-–°–¢–û–†–ò–ó (–ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù) */}
          {viewingStory && viewingStory.type === 'insta' && (
            <div className="fixed inset-0 z-[100] bg-black flex flex-col animate-[fadeIn_0.2s_ease-out]">
              <div className="absolute top-0 left-0 right-0 p-4 flex gap-1 z-20 pt-6">
                {viewingStory.images.map((_, i) => (
                  <div key={i} className={`h-1 flex-1 rounded-full ${i === storyImageIdx ? 'bg-white' : 'bg-white/30'}`} />
                ))}
              </div>
              <button onClick={() => { triggerHaptic(); setViewingStory(null); }} className="absolute top-10 right-4 z-20 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center font-bold text-xl pb-1">√ó</button>
              
              <div className="flex-1 relative flex items-center justify-center">
                {viewingStory.images[storyImageIdx] ? (
                  <img src={viewingStory.images[storyImageIdx]} className="w-full h-full object-cover" />
                ) : (
                  <span className="text-gray-500">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                )}
                
                {/* –ù–µ–≤–∏–¥–∏–º—ã–µ –∑–æ–Ω—ã –¥–ª—è —Ç–∞–ø–æ–≤ */}
                <div className="absolute top-0 left-0 w-1/3 h-full z-10" onClick={() => { 
                  triggerHaptic(); 
                  if (storyImageIdx > 0) setStoryImageIdx(storyImageIdx - 1); 
                }}></div>
                <div className="absolute top-0 right-0 w-2/3 h-full z-10" onClick={() => { 
                  triggerHaptic(); 
                  if (storyImageIdx < viewingStory.images.length - 1) setStoryImageIdx(storyImageIdx + 1); 
                  else setViewingStory(null); 
                }}></div>
              </div>
            </div>
          )}

          {showMemo && renderMemoModal()}

          {/* –í–°–ü–õ–´–í–ê–Æ–©–ï–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ó–ê–ü–ò–°–ò */}
          {editingBooking && (
            <div className="fixed inset-0 z-[110] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-[fadeIn_0.3s_ease-out]">
              <div className="bg-[#1A1A1A] border border-[#C89D7C]/30 rounded-3xl w-full max-w-sm p-6 shadow-[0_0_40px_rgba(200,157,124,0.15)]">
                <h3 className="text-xl font-bold text-white mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input 
                   type="text" 
                   value={editBName} 
                   onChange={e => setEditBName(e.target.value)} 
                   className="w-full bg-[#2A2A2A] rounded-xl p-3 text-white text-sm mb-4 focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                />

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–ó–æ–Ω—ã (–£—Å–ª—É–≥–∏)</label>
                <input 
                   type="text" 
                   value={editBServices} 
                   onChange={e => setEditBServices(e.target.value)} 
                   className="w-full bg-[#2A2A2A] rounded-xl p-3 text-white text-sm mb-4 focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                />

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–î–∞—Ç–∞</label>
                <div className="mb-4">
                   <GlassSelect value={editBDate} options={dateOptions} onChange={setEditBDate} placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" />
                </div>

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–í—Ä–µ–º—è</label>
                <div className="mb-4">
                   <GlassTimePicker value={editBTime} onChange={setEditBTime} />
                </div>

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç)</label>
                <input 
                   type="number" step="15" 
                   value={editBDuration} 
                   onChange={e => setEditBDuration(e.target.value === '' ? '' : Number(e.target.value))} 
                   className="w-full bg-[#2A2A2A] rounded-xl p-3 text-white text-sm mb-6 focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                />

                <div className="flex gap-3">
                  <button onClick={() => setEditingBooking(null)} className="flex-1 py-3 rounded-xl border border-gray-700 text-gray-400 font-medium hover:bg-gray-800 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={() => {
                     if(!editBDate || !editBTime || editBDuration === '' || editBDuration === null || !editBName.trim() || !editBServices.trim()) {
                         return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –∏–º—è, –∑–æ–Ω—ã, –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!");
                     }
                     triggerHaptic();

                     const updatedB = { ...editingBooking, date: editBDate, time: editBTime, duration: editBDuration, clientName: editBName, services: editBServices };
                     
                     // –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï - –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ!
                     setBookingsList(prev => prev.map(b => b.id === updatedB.id ? updatedB : b));

                     if(db) db.collection("bookings").doc(updatedB.id).update({
                         date: editBDate, time: editBTime, duration: editBDuration, clientName: editBName, services: editBServices
                     });

                     const newDates = [...editData.dates];
                     if (editingBooking.date !== editBDate || editingBooking.time !== editBTime) {
                         const oldDIdx = newDates.findIndex(d => d.date === editingBooking.date);
                         if (oldDIdx !== -1 && !newDates[oldDIdx].slots.includes(editingBooking.time)) {
                             newDates[oldDIdx].slots.push(editingBooking.time);
                             newDates[oldDIdx].slots.sort();
                         }
                     }
                     
                     const newDIdx = newDates.findIndex(d => d.date === editBDate);
                     if (newDIdx !== -1) {
                         newDates[newDIdx].slots = removeOverlappingSlots(newDates[newDIdx].slots, editBTime, editBDuration);
                     }

                     const newData = {...editData, dates: newDates};
                     setEditData(newData);
                     setAppData(newData);
                     syncToFirebase(newData);
                     localStorage.setItem('electroAppData', JSON.stringify(newData));

                     setEditingBooking(null);
                     showToast("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! ‚úèÔ∏è");
                  }} className="flex-[2] py-3 rounded-xl bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold shadow-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'main' && selectedServices.length > 0 && (
            <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto animate-[slideInUp_0.3s_ease-out] z-50">
              <div className="bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-x border-[#C89D7C]/30 rounded-t-3xl p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                <div className="mb-5">
                  <div className="flex justify-between items-end mb-4">
                    <div className="flex flex-col">
                      <span className="text-3xl font-bold text-[#C89D7C]">{selectedDuration} <span className="text-lg text-gray-400 font-medium">–º–∏–Ω</span></span>
                    </div>
                    <div className="flex flex-col items-end">
                      <span className="text-xs text-gray-500 mb-1">–ü—Ä–∏–º–µ—Ä–Ω–æ</span>
                      <span className="text-xl font-bold text-white">~ {totalPrice} ‚ÇΩ</span>
                    </div>
                  </div>
                  <input 
                    type="range" min="30" max="720" step="15" 
                    value={selectedDuration} 
                    onChange={(e) => setSelectedDuration(parseInt(e.target.value))}
                    className="w-full accent-[#C89D7C] h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer"
                    style={{ touchAction: 'none' }}
                  />
                  <div className="flex justify-between text-[10px] text-gray-500 mt-2 font-medium">
                    <span>30 –º–∏–Ω</span><span>3 —á</span><span>6 —á</span><span>12 —á</span>
                  </div>
                </div>
                <button onClick={() => { triggerHaptic(); setActiveTab('booking'); }} className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black p-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-bold text-lg">
                  –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É
                  <Icon name="ChevronLeft" className="w-5 h-5 rotate-180" />
                </button>
              </div>
            </div>
          )}

          {activeTab === 'booking' && selectedDate && selectedTime && (
             <div className="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto animate-[slideInUp_0.3s_ease-out] z-50">
             <button onClick={handlePreBooking} className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black p-4 rounded-3xl shadow-[0_10px_40px_rgba(200,157,124,0.2)] flex items-center justify-center gap-2 font-bold text-lg">
               –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
             </button>
           </div>
          )}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>