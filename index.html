<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ó–∞–ø–∏—Å—å –Ω–∞ –≠–ª–µ–∫—Ç—Ä–æ—ç–ø–∏–ª—è—Ü–∏—é</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background-color: #0a0a0a; 
      color: white; 
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior: none; 
      user-select: none; 
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    input, textarea, select {
      user-select: auto; 
      -webkit-user-select: auto;
    }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .glass-card-dark { 
      background: rgba(30, 30, 30, 0.4); 
      backdrop-filter: blur(12px); 
      -webkit-backdrop-filter: blur(12px); 
    }
  </style>
  <script>
    // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ò–õ–ò –ë–†–û–ù–Æ –î–õ–Ø –°–ü–ê–°–ï–ù–ò–Ø –ê–ü–ü–ö–ò!
    // –ü–æ—Ç–æ–º —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
    // document.addEventListener('contextmenu', event => event.preventDefault());
    // document.addEventListener('keydown', event => {
    //   if (event.keyCode === 123 || 
    //      (event.ctrlKey && event.shiftKey && (event.keyCode === 73 || event.keyCode === 74)) || 
    //      (event.ctrlKey && event.keyCode === 85) || 
    //      (event.ctrlKey && event.keyCode === 67) || 
    //      (event.metaKey && event.altKey && event.keyCode === 73)) { 
    //       event.preventDefault();
    //   }
    // });
  </script>
</head>
<body class="bg-[#0a0a0a] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-[#0a0a0a] to-black font-sans selection:bg-[#C89D7C]/30">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // =========================================================================
    // ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò - –ó–ê–ü–û–õ–ù–ò–¢–ï –≠–¢–ò –ü–û–õ–Ø –°–í–û–ò–ú–ò –î–ê–ù–ù–´–ú–ò! ‚ö†Ô∏è
    // =========================================================================

    const ADMIN_TG_ID = 758556732; 
    
    const BOT_TOKEN_P1 = "8674902102:AAE"; 
    const BOT_TOKEN_P2 = "qbdZ8pbmFaq9Gx5UF8vXCbElTdNEIPzU"; 
    const BOT_TOKEN = BOT_TOKEN_P1 + BOT_TOKEN_P2;
    
    const CHAT_ID = "758556732"; 

    const FB_API_KEY_PART_1 = "AIzaSyDlDVoN"; 
    const FB_API_KEY_PART_2 = "dfA1TsrfvssVcAcXDxEktJtT28c"; 
    
    const firebaseConfig = {
      apiKey: FB_API_KEY_PART_1 + FB_API_KEY_PART_2,
      authDomain: "electro-6335d.firebaseapp.com", 
      projectId: "electro-6335d", 
      storageBucket: "electro-6335d.firebasestorage.app", 
      messagingSenderId: "385798330790", 
      appId: "1:385798330790:web:4f35f12cf734d01bd51767" 
    };

    if (!firebase.apps.length && firebaseConfig.projectId !== "–í–ê–®_–ü–†–û–ï–ö–¢") {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.apps.length ? firebase.firestore() : null;

    // –§–∏–∫—Å –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å–µ—Ç–∏/VPN –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞
    if (db) {
      try {
        db.settings({ experimentalForceLongPolling: true });
      } catch(e) {}
    }

    // =========================================================================
    // –ü–û–î–£–®–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (ERROR BOUNDARY)
    // =========================================================================
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      componentDidCatch(error, errorInfo) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error, errorInfo);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-[100dvh] bg-[#0a0a0a] flex flex-col items-center justify-center p-6 text-center animate-[fadeIn_0.3s_ease-out]">
               <div className="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mb-6 border border-red-500/30">
                  <span className="text-4xl">‚ö†Ô∏è</span>
               </div>
               <h2 className="text-2xl font-bold text-white mb-2">–û–π! –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞</h2>
               <p className="text-sm text-gray-400 mb-8 max-w-[280px]">
                  –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ø–∞–ª –Ω–µ–≤–∏–¥–∏–º—ã–π —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏) –∏–ª–∏ –∫—Ä–∏–≤–∞—è —Å—Å—ã–ª–∫–∞. 
               </p>
               <button onClick={() => {
                  localStorage.removeItem('electroAppData');
                  window.location.reload();
               }} className="bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold py-4 px-8 rounded-2xl shadow-[0_5px_15px_rgba(200,157,124,0.3)] hover:opacity-90 transition-opacity">
                 –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –∏ –ø–æ—á–∏–Ω–∏—Ç—å
               </button>
               <p className="text-[10px] text-gray-600 mt-6 max-w-[250px]">
                  –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —É–¥–∞–ª–∏—Ç–µ —Å–ª–æ–º–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ masterData) –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–Ω–æ–≤–æ, –ø–µ—á–∞—Ç–∞—è —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.
               </p>
            </div>
          );
        }
        return this.props.children; 
      }
    }

    // =========================================================================

    const triggerHaptic = () => {
      try {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.selectionChanged();
        } else if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      } catch (e) { console.log(e); }
    };

    const Icon = ({ name, className }) => {
      const icons = {
        MapPin: <g><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></g>,
        Info: <g><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></g>,
        Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
        CheckCircle2: <g><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></g>,
        ChevronLeft: <g><path d="m15 18-6-6 6-6"/></g>,
        Heart: <g><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></g>,
        Sparkles: <g><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></g>,
        AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
        Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></g>
      };
      const style = name === 'Heart' ? { fill: 'currentColor' } : {};
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
          {icons[name]}
        </svg>
      );
    };

    // =========================================================================
    // –ö–ê–°–¢–û–ú–ù–´–ï –ü–†–ï–ú–ò–£–ú –ö–û–ú–ü–û–ù–ï–ù–¢–´
    // =========================================================================

    const GlassSelect = ({ value, options, onChange, placeholder, disabled }) => {
        const [isOpen, setIsOpen] = useState(false);
        const selectedLabel = options.find(o => o.value === value)?.label || value;

        return (
            <div className="flex-1 relative">
                <div onClick={(e) => { if(!disabled) { e.stopPropagation(); setIsOpen(true); } }} className={`w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#C89D7C] flex justify-between items-center cursor-pointer transition-colors ${disabled ? 'opacity-50' : 'hover:border-gray-500'}`}>
                    <span className="truncate">{selectedLabel || placeholder}</span>
                    <Icon name="ChevronLeft" className={`w-4 h-4 transition-transform -rotate-90 text-gray-400`} />
                </div>
                
                {isOpen && (
                    <div className="fixed inset-0 z-[120] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}>
                        <div onClick={e => e.stopPropagation()} className="w-full max-w-md bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-[#C89D7C]/30 rounded-t-3xl p-2 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] max-h-[60vh] flex flex-col animate-[slideInUp_0.3s_ease-out]">
                            <div className="flex justify-between items-center mb-2 mt-2 px-4">
                                <span className="text-gray-400 text-sm font-bold">{placeholder}</span>
                                <button onClick={() => setIsOpen(false)} className="w-8 h-8 bg-black/50 rounded-full text-white font-bold pb-1 flex items-center justify-center">√ó</button>
                            </div>
                            <div className="overflow-y-auto hide-scrollbar flex-1 pb-4 px-2 space-y-2 mt-2" style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                                {options.map(opt => (
                                    <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); triggerHaptic(); }} className={`p-4 rounded-xl text-center font-medium cursor-pointer transition-all ${value === opt.value ? 'bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black shadow-lg' : 'bg-[#2A2A2A] text-white hover:bg-[#333]'}`}>
                                        {opt.label}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const GlassTimePicker = ({ value, onChange, disabled }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [hour, setHour] = useState(value ? value.split(':')[0] : '14');
      const [minute, setMinute] = useState(value ? value.split(':')[1] : '00');
      
      const hours = Array.from({length: 13}, (_, i) => String(i + 9).padStart(2, '0'));
      const minutes = ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];

      const hourRef = useRef(null);
      const minRef = useRef(null);

      useEffect(() => {
        if (isOpen) {
            setHour(value ? value.split(':')[0] : '14');
            setMinute(value ? value.split(':')[1] : '00');
        }
      }, [isOpen, value]);

      useEffect(() => {
          if (isOpen && hourRef.current && minRef.current) {
              const hIdx = hours.indexOf(hour);
              const mIdx = minutes.indexOf(minute);
              setTimeout(() => {
                  if(hourRef.current) hourRef.current.scrollTop = (hIdx !== -1 ? hIdx : 0) * 50;
                  if(minRef.current) minRef.current.scrollTop = (mIdx !== -1 ? mIdx : 0) * 50;
              }, 10);
          }
      }, [isOpen]);

      const handleScroll = (ref, arr, setter) => {
          if (!ref.current) return;
          const idx = Math.round(ref.current.scrollTop / 50);
          if (arr[idx]) setter(arr[idx]);
      };

      return (
        <div className="flex-1 relative">
          <div onClick={(e) => { if(!disabled) { e.stopPropagation(); setIsOpen(true); } }} className={`w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#C89D7C] flex justify-between items-center cursor-pointer transition-colors ${disabled ? 'opacity-50' : 'hover:border-gray-500'}`}>
            <span className="truncate">{value || '–í—Ä–µ–º—è...'}</span>
            <Icon name="Clock" className="w-4 h-4 text-gray-400" />
          </div>
          
          {isOpen && (
            <div className="fixed inset-0 z-[120] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}>
              <div onClick={e => e.stopPropagation()} className="w-full max-w-md bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-[#C89D7C]/30 rounded-t-3xl p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] animate-[slideInUp_0.3s_ease-out]">
                <div className="flex justify-between items-center mb-6">
                  <button onClick={() => { setIsOpen(false); triggerHaptic(); }} className="text-gray-400 font-medium px-2 py-1">–û—Ç–º–µ–Ω–∞</button>
                  <h3 className="text-white font-bold text-lg">–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏</h3>
                  <button onClick={() => { onChange(`${hour}:${minute}`); setIsOpen(false); triggerHaptic(); }} className="text-[#C89D7C] font-bold px-2 py-1">–ì–æ—Ç–æ–≤–æ</button>
                </div>
                
                <div className="flex justify-center gap-4 relative h-[150px] mb-4">
                  <div className="absolute top-1/2 -translate-y-1/2 left-4 right-4 h-[50px] bg-white/5 border-y border-[#C89D7C]/30 rounded-lg pointer-events-none z-0"></div>
                  
                  <div className="w-24 h-full overflow-y-auto hide-scrollbar snap-y snap-mandatory relative z-10" ref={hourRef} onScroll={() => handleScroll(hourRef, hours, setHour)} style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                    <div className="h-[50px]"></div>
                    {hours.map(h => (
                      <div key={h} className={`h-[50px] flex items-center justify-center snap-center text-3xl font-bold transition-colors ${hour === h ? 'text-[#C89D7C]' : 'text-gray-600'}`}>{h}</div>
                    ))}
                    <div className="h-[50px]"></div>
                  </div>
                  
                  <div className="flex items-center justify-center text-3xl font-bold text-white z-10 h-full pb-1">:</div>
                  
                  <div className="w-24 h-full overflow-y-auto hide-scrollbar snap-y snap-mandatory relative z-10" ref={minRef} onScroll={() => handleScroll(minRef, minutes, setMinute)} style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                    <div className="h-[50px]"></div>
                    {minutes.map(m => (
                      <div key={m} className={`h-[50px] flex items-center justify-center snap-center text-3xl font-bold transition-colors ${minute === m ? 'text-[#C89D7C]' : 'text-gray-600'}`}>{m}</div>
                    ))}
                    <div className="h-[50px]"></div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const GlassDurationPicker = ({ value, onChange, disabled }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [mins, setMins] = useState(value || 30);
      const durations = Array.from({length: 36}, (_, i) => (i + 1) * 10); // 10, 20 ... 360

      const listRef = useRef(null);

      useEffect(() => {
        if (isOpen) {
            setMins(value || 30);
        }
      }, [isOpen, value]);

      useEffect(() => {
          if (isOpen && listRef.current) {
              const idx = durations.indexOf(mins);
              setTimeout(() => {
                  if(listRef.current) listRef.current.scrollTop = (idx !== -1 ? idx : 0) * 50;
              }, 10);
          }
      }, [isOpen]);

      const handleScroll = () => {
          if (!listRef.current) return;
          const idx = Math.round(listRef.current.scrollTop / 50);
          if (durations[idx]) setMins(durations[idx]);
      };

      return (
        <div className="relative">
          <div onClick={(e) => { if(!disabled) { e.stopPropagation(); setIsOpen(true); } }} className={`w-24 bg-[#2A2A2A] border border-gray-700 rounded-xl p-1.5 text-white text-sm focus:outline-none focus:border-[#C89D7C] flex justify-between items-center cursor-pointer transition-colors ${disabled ? 'opacity-50' : 'hover:border-gray-500'}`}>
            <span className="truncate pl-1 font-medium">{value ? `${value} –º–∏–Ω` : '–í—Ä–µ–º—è'}</span>
            <Icon name="ChevronLeft" className="w-3 h-3 -rotate-90 text-gray-400 mr-1" />
          </div>
          
          {isOpen && (
            <div className="fixed inset-0 z-[120] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={(e) => { e.stopPropagation(); setIsOpen(false); }}>
              <div onClick={e => e.stopPropagation()} className="w-full max-w-md bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-[#C89D7C]/30 rounded-t-3xl p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] animate-[slideInUp_0.3s_ease-out]">
                <div className="flex justify-between items-center mb-6">
                  <button onClick={() => { setIsOpen(false); triggerHaptic(); }} className="text-gray-400 font-medium px-2 py-1">–û—Ç–º–µ–Ω–∞</button>
                  <h3 className="text-white font-bold text-lg">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                  <button onClick={() => { onChange(mins); setIsOpen(false); triggerHaptic(); }} className="text-[#C89D7C] font-bold px-2 py-1">–ì–æ—Ç–æ–≤–æ</button>
                </div>
                
                <div className="flex justify-center relative h-[150px] mb-4">
                  <div className="absolute top-1/2 -translate-y-1/2 left-10 right-10 h-[50px] bg-white/5 border-y border-[#C89D7C]/30 rounded-lg pointer-events-none z-0"></div>
                  
                  <div className="w-32 h-full overflow-y-auto hide-scrollbar snap-y snap-mandatory relative z-10" ref={listRef} onScroll={handleScroll} style={{ touchAction: 'pan-y', WebkitOverflowScrolling: 'touch' }}>
                    <div className="h-[50px]"></div>
                    {durations.map(d => (
                      <div key={d} className={`h-[50px] flex items-center justify-center snap-center text-3xl font-bold transition-colors ${mins === d ? 'text-[#C89D7C]' : 'text-gray-600'}`}>
                        {d}
                      </div>
                    ))}
                    <div className="h-[50px]"></div>
                  </div>
                  <div className="flex items-center justify-center text-lg font-medium text-gray-500 z-10 h-full pl-2 pointer-events-none">–º–∏–Ω</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // =========================================================================

    const generateCalendarDays = () => {
      const days = [];
      const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
      const weekDays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const today = new Date();
      for(let i=0; i<42; i++) {
         const d = new Date(today);
         d.setDate(today.getDate() + i);
         days.push({
           date: `${d.getDate()} ${months[d.getMonth()]}`,
           day: weekDays[d.getDay()]
         });
      }
      return days;
    };
    const globalCalendarDays = generateCalendarDays();
    const dateOptions = globalCalendarDays.map(d => ({ value: d.date, label: d.date }));
    const defaultSlots = ['10:00', '11:30', '14:00', '16:00', '18:30'];

    const initialMasterData = {
      name: "–¢–≤–æ–µ –ò–º—è",
      profession: "–ú–∞—Å—Ç–µ—Ä —ç–ª–µ–∫—Ç—Ä–æ—ç–ø–∏–ª—è—Ü–∏–∏",
      photoUrl: "https://images.unsplash.com/photo-1616683693504-3ea7e9ad6fec?q=80&w=200&auto=format&fit=crop",
      address: "–£—é—Ç–Ω–∞—è —Å—Ç—É–¥–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ (–º. –ö–∏—Ç–∞–π-–≥–æ—Ä–æ–¥)",
      addressNote: "–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –ø—Ä–∏—à–ª—é –∑–∞ –¥–µ–Ω—å –¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã ü§´",
      mapLink: "", 
      pricePerMinute: 40,
      about: "–£–¥–∞–ª—è—é –≤–æ–ª–æ—Å—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –†–∞–±–æ—Ç–∞—é –±–µ—Ä–µ–∂–Ω–æ, —Å—Ç–µ—Ä–∏–ª—å–Ω–æ –∏ —Å –ª—é–±–æ–≤—å—é –∫ —Ç–≤–æ–µ–º—É —Ç–µ–ª—É. ‚ú®",
      stories: [
        { id: 'st1', name: '–û—Ç–∑—ã–≤—ã', type: 'reviews', content: '', images: [] },
        { id: 'st2', name: '–î–æ/–ü–æ—Å–ª–µ', type: 'gallery', content: '', images: ['https://images.unsplash.com/photo-1512496015851-a1fbbfc614d3?q=80&w=400', 'https://images.unsplash.com/photo-1616683693504-3ea7e9ad6fec?q=80&w=400'] },
        { id: 'st3', name: '–ü—Ä–∞–π—Å', type: 'page', content: '–ú–∞–ª–∞—è –∑–æ–Ω–∞: 500‚ÇΩ\n–°—Ä–µ–¥–Ω—è—è –∑–æ–Ω–∞: 1000‚ÇΩ\n–ë–æ–ª—å—à–∞—è –∑–æ–Ω–∞: 2000‚ÇΩ', images: [] },
        { id: 'st4', name: '–ö–∞–±–∏–Ω–µ—Ç', type: 'insta', content: '', images: ['https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?q=80&w=400'] },
        { id: 'st5', name: '', type: 'insta', content: '', images: [] }
      ],
      memo: [
        "–î–ª–∏–Ω–∞ –≤–æ–ª–æ—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 5 –º–º.",
        "–ó–∞ —Å—É—Ç–∫–∏ –¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –Ω–µ –Ω–∞–Ω–æ—Å–∏—Ç—å –∫—Ä–µ–º—ã –∏ –º–∞—Å–ª–∞ –Ω–∞ –∑–æ–Ω—É.",
        "–ü—Ä–∏–º–∏ –¥—É—à –ø–µ—Ä–µ–¥ —Å–µ–∞–Ω—Å–æ–º.",
        "–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∞–Ω–µ—Å—Ç–µ–∑–∏—é (–∫—Ä–µ–º), –Ω–∞–Ω–µ—Å–∏ –ø–æ–¥ –ø–ª–µ–Ω–∫—É –∑–∞ 1.5 —á–∞—Å–∞ –¥–æ –∑–∞–ø–∏—Å–∏."
      ],
      services: [
        { id: 's1', name: '–õ–∏—Ü–æ (—É—Å–∏–∫–∏, –ø–æ–¥–±–æ—Ä–æ–¥–æ–∫)', defaultTime: 30, icon: '‚ú®' },
        { id: 's2', name: '–ü–æ–¥–º—ã—à–µ—á–Ω—ã–µ –≤–ø–∞–¥–∏–Ω—ã', defaultTime: 60, icon: 'üå∏' },
        { id: 's3', name: '–ë–∏–∫–∏–Ω–∏ –∫–ª–∞—Å—Å–∏–∫–∞', defaultTime: 120, icon: 'üëô' },
        { id: 's4', name: '–ì–æ–ª–µ–Ω–∏', defaultTime: 180, icon: 'ü¶µ' },
      ],
      addons: [
        { id: 'a1', name: '–ò–≥–æ–ª–æ—á–∫–∞-—ç–ª–µ–∫—Ç—Ä–æ–¥', price: 200, icon: 'ü™°' },
        { id: 'a2', name: '–ê–Ω–µ—Å—Ç–µ–∑–∏—è (–∫—Ä–µ–º/–≥–µ–ª—å)', price: 400, icon: 'üßä' }
      ],
      dates: [
        { date: globalCalendarDays[1].date, day: globalCalendarDays[1].day, slots: [...defaultSlots] },
        { date: globalCalendarDays[2].date, day: globalCalendarDays[2].day, slots: [...defaultSlots] },
        { date: globalCalendarDays[3].date, day: globalCalendarDays[3].day, slots: [...defaultSlots] }
      ],
      reviews: [
        { id: 'r1', name: '–ú–∞—Ä–∏—è', text: '–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –º–∞—Å—Ç–µ—Ä! –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ—à–ª–∞ –æ—á–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—É–ø–µ—Ä!', rating: 5, date: new Date().toISOString(), approved: true }
      ],
      clients: [] 
    };

    // ==========================================
    // –£–ú–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –ü–ï–†–ï–ö–†–´–í–ê–Æ–©–ò–•–°–Ø –°–õ–û–¢–û–í
    // ==========================================
    const removeOverlappingSlots = (slots, startTime, durationMins) => {
      const [h, m] = startTime.split(':').map(Number);
      const startMins = h * 60 + m;
      const endMins = startMins + durationMins;
      
      return slots.filter(time => {
          const [th, tm] = time.split(':').map(Number);
          const tMins = th * 60 + tm;
          return tMins < startMins || tMins >= endMins;
      });
    };

    function App() {
      const [appData, setAppData] = useState(() => {
        const saved = localStorage.getItem('electroAppData');
        let parsed = saved ? JSON.parse(saved) : initialMasterData;
        if (parsed.stories && parsed.stories.length > 0 && typeof parsed.stories[0] === 'string') {
          parsed.stories = parsed.stories.map((name, i) => ({
            id: 'st' + i, name: name, type: name.toLowerCase() === '–æ—Ç–∑—ã–≤—ã' ? 'reviews' : 'page', content: '', images: []
          }));
        }
        if (parsed.slots && Array.isArray(parsed.slots)) {
          parsed.dates = parsed.dates.map(d => ({ ...d, slots: d.slots ? d.slots : parsed.slots }));
          delete parsed.slots; 
        }
        if (parsed.dates) {
          parsed.dates = parsed.dates.map(d => ({...d, slots: d.slots || []}));
        }
        if (!parsed.clients) parsed.clients = [];
        return parsed;
      });

      const [activeTab, setActiveTab] = useState('main'); 
      const [selectedServices, setSelectedServices] = useState([]);
      const [selectedDate, setSelectedDate] = useState(null);
      const [selectedTime, setSelectedTime] = useState(null);
      const [showMemo, setShowMemo] = useState(false);
      const [selectedDuration, setSelectedDuration] = useState(30); 
      const [selectedAddons, setSelectedAddons] = useState([]); 
      const [tapCount, setTapCount] = useState(0);
      const [clientPhone, setClientPhone] = useState(''); 
      const [dbConnected, setDbConnected] = useState(false);
      const [showAdminGear, setShowAdminGear] = useState(false);
      const [toastMsg, setToastMsg] = useState('');

      const [revName, setRevName] = useState('');
      const [revText, setRevText] = useState('');
      const [revRating, setRevRating] = useState('5');

      const [viewingStory, setViewingStory] = useState(null);
      const [storyImageIdx, setStoryImageIdx] = useState(0);

      // ==========================================
      // –°–û–°–¢–û–Ø–ù–ò–Ø –ê–î–ú–ò–ù–ö–ò 
      // ==========================================
      const [editData, setEditData] = useState(appData);
      const [adminSelectedDateObj, setAdminSelectedDateObj] = useState(null);
      const [newTimeVal, setNewTimeVal] = useState('');
      const [isSaving, setIsSaving] = useState(false);

      const [adminTab, setAdminTab] = useState('settings'); 
      const [adminSubView, setAdminSubView] = useState('main'); 
      
      const [bookingsList, setBookingsList] = useState([]);
      const [loadingBookings, setLoadingBookings] = useState(false);
      const [showManualBooking, setShowManualBooking] = useState(false);
      
      const [manualName, setManualName] = useState('');
      const [manualDate, setManualDate] = useState('');
      const [manualTime, setManualTime] = useState('');
      const [manualService, setManualService] = useState('');
      const [manualPhone, setManualPhone] = useState(''); 

      const [adminCalendarDate, setAdminCalendarDate] = useState(globalCalendarDays[0].date);
      const [calendarMonth, setCalendarMonth] = useState(new Date()); 
      const hoursList = Array.from({length: 13}, (_, i) => i + 9); 
      
      const [editingBooking, setEditingBooking] = useState(null);
      const [editBDate, setEditBDate] = useState('');
      const [editBTime, setEditBTime] = useState('');
      const [editBDuration, setEditBDuration] = useState(60);
      const [editBName, setEditBName] = useState(''); 
      const [editBServices, setEditBServices] = useState(''); // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–æ–Ω
      
      const [expandedClientTgId, setExpandedClientTgId] = useState(null);
      const [showAddClient, setShowAddClient] = useState(false);
      const [newClientName, setNewClientName] = useState('');
      const [newClientContact, setNewClientContact] = useState('');
      const [newClientPhone, setNewClientPhone] = useState(''); 
      const [clientSearch, setClientSearch] = useState(''); 
      // ==========================================

      let tapTimeout = useRef(null);

      const showToast = (msg) => {
        setToastMsg(msg);
        setTimeout(() => setToastMsg(''), 3000);
      };

      const fetchBookings = async () => {
        if (!db) return;
        setLoadingBookings(true);
        try {
          const snap = await db.collection("bookings").get();
          let b = [];
          snap.forEach(doc => b.push(doc.data()));
          setBookingsList(b);
        } catch(e) { console.error(e); }
        setLoadingBookings(false);
      };

      useEffect(() => {
        if (adminTab === 'calendar' || adminTab === 'clients') fetchBookings();
      }, [adminTab]);

      useEffect(() => {
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
          if (window.Telegram.WebApp.disableVerticalSwipes) {
              window.Telegram.WebApp.disableVerticalSwipes();
          }
        }

        if (db) {
          // –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          db.collection("settings").doc("masterData").get().then((doc) => {
            setDbConnected(true); 
            if (doc.exists) {
              let parsed = doc.data();
              if (parsed.stories && parsed.stories.length > 0 && typeof parsed.stories[0] === 'string') {
                parsed.stories = parsed.stories.map((name, i) => ({
                  id: 'st' + i, name: name, type: name.toLowerCase() === '–æ—Ç–∑—ã–≤—ã' ? 'reviews' : 'page', content: '', images: []
                }));
              }
              if (parsed.slots && Array.isArray(parsed.slots)) {
                parsed.dates = parsed.dates.map(d => ({ ...d, slots: d.slots ? d.slots : parsed.slots }));
                delete parsed.slots;
              }
              if (parsed.dates) {
                parsed.dates = parsed.dates.map(d => ({...d, slots: d.slots || []}));
              }
              if (parsed.mapLink === undefined) parsed.mapLink = "";
              
              // –ß–∏—Ç–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –Ω–æ–≤–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
              db.collection("clients").get().then((snap) => {
                 let cList = [];
                 snap.forEach(d => cList.push(d.data()));
                 
                 // –ï—Å–ª–∏ –Ω–æ–≤–∞—è –±–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç–∞—è, –±–µ—Ä–µ–º –∏—Ö –∏–∑ —Å—Ç–∞—Ä—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–º–∏–≥—Ä–∞—Ü–∏—è)
                 const finalClients = cList.length > 0 ? cList : (parsed.clients || []);
                 
                 const finalData = { ...parsed, clients: finalClients };
                 setAppData(finalData);
                 setEditData(finalData);
                 
                 // –ï—Å–ª–∏ –º—ã —Å–¥–µ–ª–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—é, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –ø–æ-–Ω–æ–≤–æ–º—É
                 if (cList.length === 0 && parsed.clients && parsed.clients.length > 0) {
                     parsed.clients.forEach(c => db.collection("clients").doc(String(c.tgId)).set(c).catch(console.error));
                 }
              }).catch(err => {
                 const finalData = { ...parsed, clients: parsed.clients || [] };
                 setAppData(finalData);
                 setEditData(finalData);
              });
            }
          }).catch(err => {
            setDbConnected(false); 
            console.error("Firebase load error:", err);
          });
        } else {
          setDbConnected(false);
        }
      }, []);

      const syncToFirebase = async (newData) => {
        if (db) {
          try {
            const dataToSave = { ...newData };
            // –ë–û–õ–¨–®–ï –ù–ï –°–û–•–†–ê–ù–Ø–ï–ú –ö–õ–ò–ï–ù–¢–û–í –í SETTINGS!
            delete dataToSave.clients; 
            await db.collection("settings").doc("masterData").set(dataToSave);
            setDbConnected(true);
          } catch (error) {
            console.error("Firebase sync error:", error);
            setDbConnected(false);
          }
        }
      };

      const saveClientToFirebase = (clientObj) => {
          if (db) db.collection("clients").doc(String(clientObj.tgId)).set(clientObj).catch(console.error);
      };

      const deleteClientFromFirebase = (tgId) => {
          if (db) db.collection("clients").doc(String(tgId)).delete().catch(console.error);
      };

      const handleNameClick = () => {
        if (tapTimeout.current) clearTimeout(tapTimeout.current);
        setTapCount(prev => {
          if (prev + 1 >= 5) {
            const userTgId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            if (userTgId === ADMIN_TG_ID || !window.Telegram?.WebApp?.initDataUnsafe?.user) {
              setEditData(appData); 
              setShowAdminGear(true);
              triggerHaptic();
            } else {
              alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –í–∞—à TG ID: " + (userTgId || "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"));
            }
            return 0;
          }
          return prev + 1;
        });
        tapTimeout.current = setTimeout(() => setTapCount(0), 1000);
      };

      const toggleService = (service) => {
        triggerHaptic();
        let newServices;
        if (selectedServices.find(s => s.id === service.id)) {
          newServices = selectedServices.filter(s => s.id !== service.id);
        } else {
          newServices = [...selectedServices, service];
        }
        
        setSelectedServices(newServices);

        if (newServices.length > 0) {
          const suggestedTime = newServices.reduce((sum, s) => sum + parseInt(s.defaultTime), 0);
          setSelectedDuration(suggestedTime > 360 ? 360 : (suggestedTime < 30 ? 30 : suggestedTime)); 
        } else {
          setSelectedDuration(30);
        }
      };

      const toggleAddon = (addon) => {
        triggerHaptic();
        if (selectedAddons.find(a => a.id === addon.id)) {
          setSelectedAddons(selectedAddons.filter(a => a.id !== addon.id));
        } else {
          setSelectedAddons([...selectedAddons, addon]);
        }
      };

      const selectDateSlot = (dateObj) => { 
        triggerHaptic(); 
        setSelectedDate(dateObj.date); 
        setSelectedTime(null); 
      };
      
      const selectTimeSlot = (timeStr) => { 
          triggerHaptic(); 
          setSelectedTime(timeStr); 
      };

      const addonsPrice = selectedAddons.reduce((sum, addon) => sum + parseInt(addon.price), 0);
      const totalPrice = (selectedDuration * appData.pricePerMinute) + addonsPrice;

      const handlePreBooking = () => setShowMemo(true);

      const isUserBlacklisted = () => {
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        if (!tgUser.id) return false;
        const client = (appData.clients || []).find(c => c.tgId === tgUser.id);
        return client?.isBlacklisted || false;
      };

      const isExistingClient = () => {
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        if (!tgUser.id) return false;
        return (appData.clients || []).some(c => c.tgId === tgUser.id);
      };

      const handleFinalBooking = async () => {
        if (!isExistingClient() && (!clientPhone || !clientPhone.trim())) {
           alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!");
           return;
        }

        triggerHaptic();
        setShowMemo(false); 
        setActiveTab('success'); 

        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
        const clientName = tgUser.first_name ? `${tgUser.first_name} ${tgUser.last_name || ''}`.trim() : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç";
        const clientUsername = tgUser.username ? `(@${tgUser.username})` : "";
        const clientId = tgUser.id ? `(ID: ${tgUser.id})` : "";

        const servicesList = selectedServices.map(s => s.name).join(', ');
        const addonsList = selectedAddons.length > 0 ? `\n‚ûï –î–æ–ø—ã: ${selectedAddons.map(a => a.name).join(', ')}` : '';
        
        let updatedClients = [...(appData.clients || [])];
        let finalClientName = clientName;
        
        if (tgUser.id) {
            const cIdx = updatedClients.findIndex(c => c.tgId === tgUser.id);
            let finalClientObj;
            if (cIdx !== -1) {
                updatedClients[cIdx].visits = (updatedClients[cIdx].visits || 0) + 1;
                updatedClients[cIdx].username = clientUsername || updatedClients[cIdx].username;
                if (clientPhone) updatedClients[cIdx].phone = clientPhone;
                finalClientName = updatedClients[cIdx].customName || updatedClients[cIdx].originalName || clientName;
                finalClientObj = updatedClients[cIdx];
            } else {
                finalClientObj = {
                    tgId: tgUser.id,
                    originalName: clientName,
                    customName: '',
                    username: clientUsername,
                    phone: clientPhone,
                    visits: 1,
                    totalSpent: totalPrice,
                    isBlacklisted: false,
                    firstVisit: new Date().toISOString()
                };
                updatedClients.push(finalClientObj);
            }
            saveClientToFirebase(finalClientObj);
        }
        
        const messageToAdmin = `üî• *–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å!*\n\n` +
                        `üë§ –ö–ª–∏–µ–Ω—Ç: ${finalClientName} ${clientUsername} ${clientId}\n` +
                        (clientPhone ? `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${clientPhone}\n` : ``) +
                        `üìÖ ${selectedDate} –≤ ${selectedTime}\n` +
                        `üå∏ –ó–æ–Ω—ã: ${servicesList}${addonsList}\n` +
                        `‚è≥ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${selectedDuration} –º–∏–Ω\n` +
                        `üí∞ –û–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞: ~${totalPrice} ‚ÇΩ`;

        if (BOT_TOKEN && !BOT_TOKEN.includes("–í–ê–®_–¢–û–ö–ï–ù")) {
          try {
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chat_id: CHAT_ID,
                text: messageToAdmin,
                parse_mode: 'Markdown'
              })
            });
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω—É", error);
          }

          if (tgUser.id) {
            const messageToClient = `‚ú® *${finalClientName}, –≤–∞—à–∞ –∑–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!*\n\nüìÖ –î–∞—Ç–∞: ${selectedDate}\n‚è∞ –í—Ä–µ–º—è: ${selectedTime}\nüå∏ –ó–æ–Ω—ã: ${servicesList}${addonsList}\n‚è≥ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${selectedDuration} –º–∏–Ω\nüí∞ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ~${totalPrice} ‚ÇΩ\n\nüìç –ê–¥—Ä–µ—Å: ${appData.address}\n_${appData.addressNote}_\n\n–ñ–¥—É –≤–∞—Å! ‚ù§Ô∏è`;
            try {
              await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  chat_id: tgUser.id,
                  text: messageToClient,
                  parse_mode: 'Markdown'
                })
              });
            } catch (error) {
              console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É", error);
            }
          }
        }

        const newBooking = {
          id: 'b' + Date.now(),
          date: selectedDate,
          time: selectedTime,
          clientName: finalClientName,
          clientContact: clientUsername || clientId || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
          phone: clientPhone,
          services: servicesList + addonsList,
          duration: selectedDuration,
          price: totalPrice,
          tgId: tgUser.id || null,
          createdAt: new Date().toISOString()
        };

        if (db) {
          db.collection("bookings").doc(newBooking.id).set(newBooking).catch(err => console.error("Firebase booking error:", err));
        }

        const updatedDates = [...appData.dates];
        const targetDateIdx = updatedDates.findIndex(d => d.date === selectedDate);
        if (targetDateIdx !== -1) {
          updatedDates[targetDateIdx].slots = removeOverlappingSlots(updatedDates[targetDateIdx].slots, selectedTime, selectedDuration);
          const newData = { ...appData, dates: updatedDates, clients: updatedClients };
          setAppData(newData);
          setEditData(newData);
          syncToFirebase(newData);
          localStorage.setItem('electroAppData', JSON.stringify(newData));
        }
      };

      const resetBooking = () => {
        triggerHaptic();
        setActiveTab('main');
        setSelectedServices([]);
        setSelectedDate(null);
        setSelectedTime(null);
        setSelectedDuration(30);
        setSelectedAddons([]);
        setClientPhone('');
      };

      const submitClientReview = () => {
        triggerHaptic();
        if (!revName.trim() || !revText.trim()) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
          return;
        }

        const newReview = {
          id: 'r' + Date.now(),
          name: revName.trim(),
          text: revText.trim(),
          rating: parseInt(revRating),
          date: new Date().toISOString(),
          approved: false 
        };

        const currentReviews = appData.reviews || [];
        const newData = { ...appData, reviews: [newReview, ...currentReviews] };
        
        setAppData(newData);
        setEditData(newData);
        syncToFirebase(newData);
        
        showToast("–°–ø–∞—Å–∏–±–æ! –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. üíñ");
        setRevName('');
        setRevText('');
        setRevRating('5');
      };

      const openStory = (story) => {
        triggerHaptic();
        if (!story.name.trim()) return;
        
        if (story.type === 'reviews') {
          setActiveTab('reviews');
        } else if (story.type === 'page') {
          setViewingStory(story);
          setActiveTab('story_page');
        } else {
          if(!story.images || story.images.length === 0) {
             alert("–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.");
             return;
          }
          setViewingStory(story);
          setStoryImageIdx(0);
        }
      };

      const renderMain = () => (
        <div className="pb-64 animate-[fadeIn_0.5s_ease-in-out]">
          <div className="flex flex-col items-center text-center mt-6 mb-8 relative">
            
            {showAdminGear && (
              <div onClick={() => { triggerHaptic(); setActiveTab('admin'); setShowAdminGear(false); }} 
                   className="absolute top-0 left-6 bg-[#1A1A1A] p-2.5 rounded-full border border-[#C89D7C] cursor-pointer shadow-[0_0_15px_rgba(200,157,124,0.4)] animate-[zoomIn_0.3s_ease-out] z-50">
                <Icon name="Settings" className="w-6 h-6 text-[#C89D7C] animate-[spin_3s_linear_infinite]" />
              </div>
            )}

            <div className="w-28 h-28 rounded-full bg-gradient-to-tr from-[#C89D7C] to-[#E8CDB5] p-1 shadow-[0_0_20px_rgba(200,157,124,0.3)] mb-4">
              <div className="w-full h-full rounded-full bg-[#121212] flex items-center justify-center overflow-hidden relative">
                <img src={appData.photoUrl} alt="Master" className="object-cover w-full h-full opacity-90" />
              </div>
            </div>
            <h1 onClick={handleNameClick} className="text-xl font-medium text-gray-100 tracking-[0.15em] uppercase cursor-pointer select-none drop-shadow-sm mt-2">
              {appData.name}
            </h1>
            <p className="text-[#C89D7C] font-medium mt-1">{appData.profession}</p>
          </div>

          <div className="flex justify-evenly w-full px-4 mb-6">
            {appData.stories.map((story, idx) => {
              if (!story.name.trim()) return null; 
              return (
                <div key={idx} onClick={() => openStory(story)} className="flex flex-col items-center gap-2">
                  <div className="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-gradient-to-tr from-[#754E33] to-[#E8CDB5] p-[1px] cursor-pointer hover:scale-105 transition-transform">
                    <div className="w-full h-full rounded-full bg-[#1A1A1A] flex items-center justify-center">
                      <Icon name="Sparkles" className="w-5 h-5 sm:w-6 sm:h-6 text-[#C89D7C]" />
                    </div>
                  </div>
                  <span className="text-[10px] sm:text-xs text-gray-400 font-medium whitespace-nowrap">{story.name}</span>
                </div>
              );
            })}
          </div>

          <div className="grid grid-cols-2 gap-3 px-4 mt-2">
            <div className="col-span-2 glass-card-dark p-4 rounded-3xl flex items-center justify-between border border-white/5">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-[#2A2A2A] flex items-center justify-center text-[#C89D7C] shrink-0">
                  <Icon name="MapPin" className="w-5 h-5" />
                </div>
                <div>
                  <p className="text-sm font-semibold text-gray-200">{appData.address}</p>
                  <p className="text-xs text-[#C89D7C] mt-0.5">{appData.addressNote}</p>
                </div>
              </div>
              {appData.mapLink && (
                <a href={appData.mapLink} target="_blank" rel="noopener noreferrer" onClick={triggerHaptic} className="bg-[#2A2A2A] px-3 h-8 rounded-full border border-[#C89D7C]/30 flex items-center justify-center gap-1.5 hover:bg-[#333] transition-colors shrink-0 ml-2">
                   <span className="text-[10px] font-bold text-[#C89D7C] whitespace-nowrap leading-none mt-[1px]">–ö–ê–†–¢–ê</span>
                   <Icon name="MapPin" className="w-3 h-3 text-[#C89D7C]" />
                </a>
              )}
            </div>

            <div className="col-span-2 glass-card-dark p-5 rounded-3xl border border-white/5">
              <div className="flex items-center gap-2 mb-2">
                <Icon name="Info" className="w-5 h-5 text-[#C89D7C]" />
                <h3 className="font-semibold text-gray-200">–û–±–æ –º–Ω–µ</h3>
              </div>
              <p className="text-sm text-gray-400 leading-relaxed whitespace-pre-wrap">{appData.about}</p>
            </div>

            <div className="col-span-2 mt-4">
              <div className="flex items-center justify-between mb-4 px-1">
                <h2 className="text-xl font-bold text-white tracking-wide">–í—ã–±–µ—Ä–∏ –∑–æ–Ω—ã</h2>
                <div className="bg-[#2A2A2A] px-3 h-7 rounded-full border border-[#C89D7C]/30 flex items-center justify-center">
                  <span className="text-xs font-bold text-[#C89D7C] whitespace-nowrap">{appData.pricePerMinute} ‚ÇΩ / –º–∏–Ω</span>
                </div>
              </div>

              <div className="flex flex-col gap-3">
                {appData.services.map(service => {
                  const isSelected = selectedServices.find(s => s.id === service.id);
                  return (
                    <div key={service.id} onClick={() => toggleService(service)} className={`glass-card-dark p-4 rounded-3xl cursor-pointer transition-all duration-300 border ${isSelected ? 'border-[#C89D7C] bg-[#C89D7C]/10' : 'border-white/5 hover:border-white/20'}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="text-2xl">{service.icon}</div>
                          <div>
                            <h3 className="font-semibold text-gray-200">{service.name}</h3>
                            <p className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                              <Icon name="Clock" className="w-3 h-3" /> ~ {service.defaultTime} –º–∏–Ω
                            </p>
                          </div>
                        </div>
                        <div className={`w-6 h-6 rounded-full border-2 ml-auto flex items-center justify-center transition-colors ${isSelected ? 'bg-[#C89D7C] border-[#C89D7C]' : 'border-gray-600'}`}>
                          {isSelected && <Icon name="CheckCircle2" className="w-4 h-4 text-black" />}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <h2 className="text-xl font-bold text-white tracking-wide mt-6 mb-4 px-1">–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?</h2>
              <div className="flex flex-col gap-3">
                {appData.addons.map(addon => {
                  const isSelected = selectedAddons.find(a => a.id === addon.id);
                  return (
                    <div key={addon.id} onClick={() => toggleAddon(addon)} className={`glass-card-dark p-4 rounded-3xl cursor-pointer transition-all duration-300 border ${isSelected ? 'border-[#C89D7C] bg-[#C89D7C]/10' : 'border-white/5 hover:border-white/20'}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="text-2xl">{addon.icon}</div>
                          <div>
                            <h3 className="font-semibold text-gray-200">{addon.name}</h3>
                            <p className="text-xs text-[#C89D7C] mt-0.5">+ {addon.price} ‚ÇΩ</p>
                          </div>
                        </div>
                        <div className={`w-6 h-6 rounded-full border-2 ml-auto flex items-center justify-center transition-colors ${isSelected ? 'bg-[#C89D7C] border-[#C89D7C]' : 'border-gray-600'}`}>
                          {isSelected && <Icon name="CheckCircle2" className="w-4 h-4 text-black" />}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );

      const renderStoryPage = () => (
        <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out] min-h-[100dvh] w-full">
          <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
            <Icon name="ChevronLeft" className="w-5 h-5" />
            <span className="font-medium">–ù–∞–∑–∞–¥</span>
          </button>
          <h2 className="text-2xl font-bold text-white mb-6 tracking-wide">{viewingStory?.name}</h2>
          <div className="glass-card-dark p-5 rounded-3xl border border-white/5 whitespace-pre-wrap text-sm text-gray-300 leading-relaxed min-h-[50vh]">
            {viewingStory?.content || "–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç."}
          </div>
        </div>
      );

      const renderBooking = () => {
        if (isUserBlacklisted()) {
          return (
             <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out]">
                <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
                  <Icon name="ChevronLeft" className="w-5 h-5" />
                  <span className="font-medium">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
                </button>
                <div className="glass-card-dark p-6 rounded-3xl text-center border border-white/10 mt-10">
                    <h3 className="text-xl font-bold text-white mb-2">–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –Ω–µ—Ç üòî</h3>
                    <p className="text-gray-400 text-sm">–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∑–∂–µ.</p>
                </div>
             </div>
          );
        }

        const availableSlotsForDate = appData.dates.find(d => d.date === selectedDate)?.slots || [];

        return (
          <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out]">
            <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
              <Icon name="ChevronLeft" className="w-5 h-5" />
              <span className="font-medium">–ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º</span>
            </button>

            <h2 className="text-2xl font-bold text-white mb-6 tracking-wide">–í—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è</h2>

            <div className="mb-8 relative">
              <div className="flex justify-between items-end mb-3">
                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã</h3>
                <div className="flex items-center gap-1 text-[#C89D7C] text-[10px] uppercase font-bold tracking-widest animate-pulse pr-1">
                  <span>–õ–∏—Å—Ç–∞–π</span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="rotate-180"><path d="m15 18-6-6 6-6"/></svg>
                </div>
              </div>
              
              <div className="flex gap-3 overflow-x-auto pb-2 hide-scrollbar">
                {appData.dates.map((item, idx) => (
                  <div key={idx} onClick={() => selectDateSlot(item)} className={`flex flex-col items-center justify-center min-w-[70px] h-20 rounded-2xl cursor-pointer transition-all border shrink-0 ${selectedDate === item.date ? 'bg-gradient-to-b from-[#C89D7C] to-[#9A6A45] text-black shadow-[0_5px_15px_rgba(200,157,124,0.3)] border-transparent' : 'glass-card-dark text-gray-300 border-white/5'}`}>
                    <span className="text-xs mb-1 opacity-80">{item.day}</span>
                    <span className="text-xl font-bold">{item.date.split(' ')[0]}</span>
                  </div>
                ))}
              </div>
            </div>

            {selectedDate && (
              <div className="animate-[fadeIn_0.5s_ease-out]">
                <h3 className="text-sm font-semibold text-gray-500 mb-3 uppercase tracking-wider">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏</h3>
                {availableSlotsForDate.length === 0 ? (
                  <p className="text-gray-400 text-sm">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫.</p>
                ) : (
                  <div className="grid grid-cols-3 gap-3">
                    {availableSlotsForDate.map((time, idx) => (
                      <div key={idx} onClick={() => selectTimeSlot(time)} className={`py-3 rounded-xl text-center font-medium cursor-pointer transition-all border ${selectedTime === time ? 'bg-[#2A2A2A] text-[#C89D7C] border-[#C89D7C] shadow-[0_0_10px_rgba(200,157,124,0.2)]' : 'glass-card-dark text-gray-400 border-white/5 hover:bg-white/5'}`}>
                        {time}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      const renderHearts = () => {
        return Array.from({ length: 25 }).map((_, i) => (
          <div key={i} className="absolute text-[#C89D7C] animate-[floatUp_linear_infinite]" 
               style={{
                 left: `${Math.random() * 100}%`,
                 animationDuration: `${Math.random() * 3 + 2}s`,
                 animationDelay: `${Math.random() * 2}s`,
                 fontSize: `${Math.random() * 15 + 10}px`,
                 opacity: 0.7
               }}>
            <Icon name="Heart" className="w-full h-full" />
          </div>
        ));
      };

      const renderSuccess = () => (
        <div className="relative px-4 h-screen flex flex-col items-center justify-center text-center animate-[zoomIn_0.5s_ease-out] overflow-hidden">
          <div className="absolute inset-0 z-0 pointer-events-none">{renderHearts()}</div>
          <div className="z-10 w-24 h-24 bg-[#C89D7C]/20 rounded-full flex items-center justify-center mb-6 border border-[#C89D7C]/50">
            <Icon name="Heart" className="w-12 h-12 text-[#C89D7C] animate-bounce" />
          </div>
          <h2 className="z-10 text-3xl font-bold text-white mb-2 shadow-black drop-shadow-lg">–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</h2>
          <p className="z-10 text-gray-300 mb-8 max-w-[250px] shadow-black drop-shadow-md">
            –ñ–¥—É —Ç–µ–±—è {selectedDate} –≤ {selectedTime}. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –∫ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ!
          </p>
          
          <div className="z-10 glass-card-dark p-6 rounded-3xl w-full text-left mb-8 border border-[#C89D7C]/30 shadow-2xl">
            <h4 className="font-semibold text-gray-200 mb-3">–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏:</h4>
            <ul className="space-y-2 mb-4">
              {selectedServices.map(s => (
                <li key={s.id} className="text-sm text-gray-300 flex justify-between">
                  <span>{s.icon} {s.name}</span>
                </li>
              ))}
              {selectedAddons.map(a => (
                <li key={a.id} className="text-sm text-[#C89D7C] flex justify-between">
                  <span>{a.icon} {a.name}</span>
                  <span className="font-medium">+ {a.price} ‚ÇΩ</span>
                </li>
              ))}
            </ul>
            <div className="pt-3 border-t border-gray-700 flex justify-between items-center mb-2">
              <span className="text-gray-400">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏:</span>
              <span className="font-medium text-gray-100">{selectedDuration} –º–∏–Ω</span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-gray-400">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
              <span className="text-xl font-bold text-[#C89D7C]">~ {totalPrice} ‚ÇΩ</span>
            </div>
          </div>

          <button onClick={resetBooking} className="z-10 w-full py-4 bg-[#2A2A2A] text-white rounded-2xl font-semibold shadow-lg border border-white/10 relative overflow-hidden group">
            <span className="relative z-10">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</span>
            <div className="absolute inset-0 bg-[#C89D7C]/20 w-0 group-hover:w-full transition-all duration-300"></div>
          </button>
        </div>
      );

      const renderMemoModal = () => (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-[fadeIn_0.3s_ease-out]">
          <div className="bg-[#1A1A1A] border border-[#C89D7C]/30 p-6 rounded-3xl w-full max-w-sm shadow-[0_0_40px_rgba(200,157,124,0.15)]">
            <div className="flex items-center gap-3 mb-4">
              <Icon name="AlertCircle" className="w-6 h-6 text-[#C89D7C]" />
              <h3 className="text-xl font-bold text-white">–í–∞–∂–Ω–æ –ø–µ—Ä–µ–¥ –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π!</h3>
            </div>
            <ul className="text-sm text-gray-300 space-y-3 mb-4 list-disc pl-5 marker:text-[#C89D7C]">
              {appData.memo.map((item, idx) => (
                <li key={idx}>{item}</li>
              ))}
            </ul>
            
            {!isExistingClient() && (
              <input 
                type="tel" 
                value={clientPhone} 
                onChange={e => setClientPhone(e.target.value)}
                placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                className="w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-3 text-white text-sm mb-6 focus:outline-none focus:border-[#C89D7C]"
              />
            )}
            
            <div className="flex gap-3">
              <button onClick={() => { triggerHaptic(); setShowMemo(false); }} className="flex-1 py-3 rounded-xl border border-gray-700 text-gray-400 font-medium hover:bg-gray-800 transition-colors">
                –ù–∞–∑–∞–¥
              </button>
              <button onClick={handleFinalBooking} className="flex-[2] py-3 rounded-xl bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold shadow-lg">
                –ü–æ–Ω—è–ª–∞, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
              </button>
            </div>
          </div>
        </div>
      );

      const renderReviews = () => {
        const approvedReviews = (appData.reviews || []).filter(r => r.approved).sort((a,b) => new Date(b.date) - new Date(a.date));

        return (
          <div className="px-4 pb-24 animate-[slideIn_0.3s_ease-out] min-h-[100dvh] w-full">
            <button onClick={() => { triggerHaptic(); setActiveTab('main'); }} className="flex items-center gap-2 text-gray-300 mt-6 mb-6 bg-[#2A2A2A] px-4 py-2 rounded-full w-max border border-white/5">
              <Icon name="ChevronLeft" className="w-5 h-5" />
              <span className="font-medium">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </button>

            <h2 className="text-2xl font-bold text-white mb-6 tracking-wide">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>

            {/* –ë–õ–û–ö –û–°–¢–ê–í–ò–¢–¨ –û–¢–ó–´–í (–ü–ï–†–ï–ù–ï–°–ï–ù –ù–ê–í–ï–†–•) */}
            <div className="glass-card-dark p-4 rounded-2xl border border-[#C89D7C]/20 relative overflow-hidden mb-8 shadow-sm">
              <div className="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-[#C89D7C] to-[#9A6A45]"></div>
              <h3 className="text-base font-bold text-white mb-3 text-center tracking-wide">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
              
              <div className="flex justify-center gap-2 mb-4">
                {[1, 2, 3, 4, 5].map(star => (
                  <span 
                    key={star} 
                    onClick={() => { triggerHaptic(); setRevRating(String(star)); }}
                    className={`text-3xl cursor-pointer transition-all ${parseInt(revRating) >= star ? 'text-[#C89D7C] drop-shadow-[0_0_8px_rgba(200,157,124,0.4)] scale-110' : 'text-gray-700 hover:text-gray-500'}`}
                  >
                    ‚òÖ
                  </span>
                ))}
              </div>

              <input 
                type="text" value={revName} onChange={e => setRevName(e.target.value)}
                placeholder="–¢–≤–æ–µ –∏–º—è" 
                className="w-full bg-black/30 border border-gray-700 rounded-lg p-2.5 text-white text-sm mb-2.5 focus:outline-none focus:border-[#C89D7C] transition-colors"
              />
              
              <textarea 
                value={revText} onChange={e => setRevText(e.target.value)}
                placeholder="–ü–æ–¥–µ–ª–∏—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏..." 
                rows="2" 
                className="w-full bg-black/30 border border-gray-700 rounded-lg p-2.5 text-white text-sm mb-4 focus:outline-none focus:border-[#C89D7C] transition-colors resize-none"
              ></textarea>

              <button onClick={submitClientReview} className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black py-2.5 rounded-lg font-bold shadow-md hover:opacity-90 transition-opacity text-sm uppercase tracking-wide">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
            </div>

            {/* –°–ü–ò–°–û–ö –û–¢–ó–´–í–û–í */}
            <div className="space-y-4 mb-8">
              {approvedReviews.length === 0 ? (
                <p className="text-gray-500 text-center py-6">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å –ø–µ—Ä–≤–æ–π!</p>
              ) : (
                approvedReviews.map(rev => (
                  <div key={rev.id} className="glass-card-dark p-5 rounded-3xl border border-white/5 relative overflow-hidden">
                    <div className="flex justify-between items-center mb-3">
                      <h4 className="font-bold text-white">{rev.name}</h4>
                      <div className="flex text-[#C89D7C] text-sm tracking-widest">
                        {'‚òÖ'.repeat(rev.rating)}{'‚òÜ'.repeat(5-rev.rating)}
                      </div>
                    </div>
                    <p className="text-sm text-gray-300 leading-relaxed mb-3">{rev.text}</p>
                    <div className="text-[10px] text-gray-500">{new Date(rev.date).toLocaleDateString('ru-RU')}</div>
                  </div>
                ))
              )}
            </div>

          </div>
        );
      };

      const renderAdminPanel = () => {
        const copyEmptySlotsToClipboard = () => {
          triggerHaptic();
          
          const availableDates = editData.dates.filter(d => d.slots && d.slots.length > 0);

          if (availableDates.length === 0) {
            showToast("–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫ üòî");
            return;
          }

          let text = "üå∏ –°–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏:\n\n";
          availableDates.forEach(d => {
            text += `üìÖ ${d.date} (${d.day}): ${d.slots.join(', ')}\n`;
          });
          text += "\n–ó–∞–ø–∏—Å—å –ø–æ —Å—Å—ã–ª–∫–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ! ‚ú®";

          try {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            showToast("–¢–µ–∫—Å—Ç –¥–ª—è —Å—Ç–æ—Ä–∏–∑ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! ü™Ñ");
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏", err);
            showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å üòî");
          }
        };

        const updateActualPrice = async (bookingId, val) => {
          const numVal = val === '' ? null : (parseInt(val) || 0);
          const updatedList = bookingsList.map(b => b.id === bookingId ? { ...b, actualPrice: numVal } : b);
          setBookingsList(updatedList);
          if (db) {
            await db.collection("bookings").doc(bookingId).update({ actualPrice: numVal }).catch(e => console.error(e));
          }
          showToast("–û–ø–ª–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! üí∞");
        };

        const addManualBooking = async () => {
          if(!manualDate || !manualTime) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –î–∞—Ç—É –∏ –í—Ä–µ–º—è!");
          triggerHaptic();

          const newB = {
            id: 'b' + Date.now(),
            date: manualDate,
            time: manualTime,
            clientName: manualName || "–ë–µ–∑ –∏–º–µ–Ω–∏",
            clientContact: "–†—É—á–Ω–∞—è –∑–∞–ø–∏—Å—å",
            phone: manualPhone,
            services: manualService || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
            duration: 60,
            price: 0,
            createdAt: new Date().toISOString()
          };

          if(db) await db.collection("bookings").doc(newB.id).set(newB);

          const newDates = [...editData.dates];
          const dIdx = newDates.findIndex(d => d.date === manualDate);
          if (dIdx !== -1) {
            newDates[dIdx].slots = removeOverlappingSlots(newDates[dIdx].slots, manualTime, 60);
            const newData = {...editData, dates: newDates};
            setEditData(newData);
            setAppData(newData);
            syncToFirebase(newData);
            localStorage.setItem('electroAppData', JSON.stringify(newData));
          }

          setManualName(''); setManualDate(''); setManualTime(''); setManualService(''); setManualPhone('');
          fetchBookings();
          setShowManualBooking(false);
          setAdminCalendarDate(manualDate);
          showToast("–°–ª–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω! ‚ú®");
        };

        const addBreak = async () => {
          if(!manualDate || !manualTime) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –î–∞—Ç—É –∏ –í—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–µ—Ä—ã–≤–∞!");
          triggerHaptic();

          const newB = {
            id: 'b' + Date.now(),
            date: manualDate,
            time: manualTime,
            clientName: "–ü–µ—Ä–µ—Ä—ã–≤",
            clientContact: "",
            services: "–û—Ç–¥—ã—Ö",
            duration: 60,
            price: 0,
            createdAt: new Date().toISOString()
          };

          if(db) await db.collection("bookings").doc(newB.id).set(newB);

          const newDates = [...editData.dates];
          const dIdx = newDates.findIndex(d => d.date === manualDate);
          if (dIdx !== -1) {
            newDates[dIdx].slots = removeOverlappingSlots(newDates[dIdx].slots, manualTime, 60);
            const newData = {...editData, dates: newDates};
            setEditData(newData);
            setAppData(newData);
            syncToFirebase(newData);
            localStorage.setItem('electroAppData', JSON.stringify(newData));
          }

          setManualName(''); setManualDate(''); setManualTime(''); setManualService(''); setManualPhone('');
          fetchBookings();
          setShowManualBooking(false);
          setAdminCalendarDate(manualDate);
          showToast("–ü–µ—Ä–µ—Ä—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω! ‚òï");
        };

        const sendReminder = async (booking) => {
          triggerHaptic();
          if (!booking.tgId) {
            showToast("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: —Ä—É—á–Ω–∞—è –∑–∞–ø–∏—Å—å (–Ω–µ—Ç –¢–ì) üòî");
            return;
          }
          if (BOT_TOKEN && !BOT_TOKEN.includes("–í–ê–®_–¢–û–ö–ï–ù")) {
             const shortName = booking.clientName.split(' ')[0];
             const text = `–ü—Ä–∏–≤–µ—Ç, ${shortName}! –ó–∞–≤—Ç—Ä–∞ –∂–¥—É —Ç–µ–±—è –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ –≤ ${booking.time}! ü§ó\n\n–ï—Å–ª–∏ –ø–ª–∞–Ω—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –º–µ–Ω—è –∑–∞—Ä–∞–Ω–µ–µ.`;
             
             const adminUsername = window.Telegram?.WebApp?.initDataUnsafe?.user?.username || "";
             const confirmText = encodeURIComponent(`–ü—Ä–∏–≤–µ—Ç! –Ø –±—É–¥—É –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –∑–∞–≤—Ç—Ä–∞ –≤ ${booking.time} ‚úÖ`);
             const cancelText = encodeURIComponent(`–ü—Ä–∏–≤–µ—Ç! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º–Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å ‚ùå`);
             
             const reply_markup = adminUsername ? {
                 inline_keyboard: [
                     [{ text: "‚úÖ –ë—É–¥—É", url: `https://t.me/${adminUsername}?text=${confirmText}` }],
                     [{ text: "‚ùå –ù–µ —Å–º–æ–≥—É / –ü–µ—Ä–µ–Ω–æ—Å", url: `https://t.me/${adminUsername}?text=${cancelText}` }]
                 ]
             } : undefined;

             try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ chat_id: booking.tgId, text: text, reply_markup: reply_markup })
                });
                showToast("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! üíå");
             } catch(e) {
                console.error(e);
                showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ üòî");
             }
          } else {
             showToast("–ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω üòî");
          }
        };

        const cancelBooking = async (booking) => {
          triggerHaptic();
          if(!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å ${booking.clientName} –Ω–∞ ${booking.date} ${booking.time}?`)) return;
          
          setBookingsList(prev => prev.filter(b => b.id !== booking.id));

          if(db) await db.collection("bookings").doc(booking.id).delete();

          const newDates = [...editData.dates];
          const dIdx = newDates.findIndex(d => d.date === booking.date);
          if (dIdx !== -1) {
            if(!newDates[dIdx].slots.includes(booking.time)){
                newDates[dIdx].slots.push(booking.time);
                newDates[dIdx].slots.sort();
            }
          } else {
             const gDay = globalCalendarDays.find(g => g.date === booking.date);
             if(gDay) {
                 newDates.push({ date: booking.date, day: gDay.day, slots: [booking.time] });
                 newDates.sort((a, b) => {
                   const idxA = globalCalendarDays.findIndex(c => c.date === a.date);
                   const idxB = globalCalendarDays.findIndex(c => c.date === b.date);
                   return (idxA !== -1 && idxB !== -1) ? idxA - idxB : 0;
                 });
             }
          }
          
          const newData = {...editData, dates: newDates};
          setEditData(newData);
          setAppData(newData);
          syncToFirebase(newData);
          localStorage.setItem('electroAppData', JSON.stringify(newData));
          
          fetchBookings();
          showToast("–ë—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–µ–Ω–∞, —Å–ª–æ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω. üîÑ");
        };

        const openEditBooking = (b) => {
            triggerHaptic();
            setEditBDate(b.date);
            setEditBTime(b.time);
            setEditBDuration(b.duration || 60);
            setEditBName(b.clientName || ""); 
            setEditBServices(b.services || ""); // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∑–æ–Ω—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            setEditingBooking(b);
        };

        const confirmEditBooking = async () => {
            if(!editBDate || !editBTime || editBDuration === '' || editBDuration === null || !editBName.trim() || !editBServices.trim()) {
                return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –∏–º—è, –∑–æ–Ω—ã, –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!");
            }
            triggerHaptic();

            const updatedB = { ...editingBooking, date: editBDate, time: editBTime, duration: editBDuration, clientName: editBName, services: editBServices };
            
            // –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï - –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ!
            setBookingsList(prev => prev.map(b => b.id === updatedB.id ? updatedB : b));

            if(db) await db.collection("bookings").doc(updatedB.id).update({
                date: editBDate, time: editBTime, duration: editBDuration, clientName: editBName, services: editBServices
            });

            const newDates = [...editData.dates];
            if (editingBooking.date !== editBDate || editingBooking.time !== editBTime) {
                const oldDIdx = newDates.findIndex(d => d.date === editingBooking.date);
                if (oldDIdx !== -1 && !newDates[oldDIdx].slots.includes(editingBooking.time)) {
                    newDates[oldDIdx].slots.push(editingBooking.time);
                    newDates[oldDIdx].slots.sort();
                }
            }
            
            const newDIdx = newDates.findIndex(d => d.date === editBDate);
            if (newDIdx !== -1) {
                newDates[newDIdx].slots = removeOverlappingSlots(newDates[newDIdx].slots, editBTime, editBDuration);
            }

            const newData = {...editData, dates: newDates};
            setEditData(newData);
            setAppData(newData);
            syncToFirebase(newData);
            localStorage.setItem('electroAppData', JSON.stringify(newData));

            setEditingBooking(null);
            showToast("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! ‚úèÔ∏è");
        };

        const getMonthGrid = (date) => {
          const year = date.getFullYear();
          const month = date.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          let startingDayOfWeek = firstDay.getDay();
          if (startingDayOfWeek === 0) startingDayOfWeek = 7;
          const grid = [];
          for (let i = 1; i < startingDayOfWeek; i++) {
             grid.push({ dateObj: new Date(year, month, 1 - (startingDayOfWeek - i)), isCurrentMonth: false });
          }
          for (let i = 1; i <= lastDay.getDate(); i++) {
             grid.push({ dateObj: new Date(year, month, i), isCurrentMonth: true });
          }
          let remaining = grid.length % 7;
          if (remaining !== 0) {
             for (let i = 1; i <= 7 - remaining; i++) {
                 grid.push({ dateObj: new Date(year, month + 1, i), isCurrentMonth: false });
             }
          }
          return grid;
        };

        const formatDateStr = (dateObj) => {
          const mNames = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
          return `${dateObj.getDate()} ${mNames[dateObj.getMonth()]}`;
        };

        const SimpleBookingBlock = ({ booking, hourHeight, onEdit, onCancel, onRemind }) => {
            const [h, m] = booking.time.split(':').map(Number);
            const initialTop = (h - 9) * hourHeight + (m / 60) * hourHeight;
            const height = Math.max((booking.duration || 30) * (hourHeight / 60), 30);
            const isBreak = booking.clientName === "–ü–µ—Ä–µ—Ä—ã–≤";

            return (
                <div 
                    onClick={() => onEdit(booking)}
                    className={`absolute left-12 right-2 rounded-xl p-2 overflow-hidden shadow-lg border hover:scale-[1.01] transition-transform z-10 cursor-pointer ${isBreak ? 'bg-gray-700 border-gray-500' : 'bg-[#C89D7C] border-[#9A6A45]'}`} 
                    style={{ top: `${initialTop}px`, height: `${height}px` }}
                >
                    <div className="flex justify-between items-start">
                        <div className={`font-bold text-xs leading-tight drop-shadow-md ${isBreak ? 'text-gray-200' : 'text-black'}`}>
                            {booking.time} - {booking.clientName}
                        </div>
                        <div className="flex gap-2 z-20">
                            {!isBreak && booking.tgId && (
                                <button onClick={(e) => { e.stopPropagation(); onRemind(booking); }} className="flex items-center justify-center w-7 h-7 bg-white/20 hover:bg-white/40 rounded-full text-sm shadow-sm backdrop-blur-md transition-all border border-white/10" title="–ù–∞–ø–æ–º–Ω–∏—Ç—å">
                                    üîî
                                </button>
                            )}
                            <button onClick={(e) => { e.stopPropagation(); onCancel(booking); }} className="flex items-center justify-center w-7 h-7 bg-red-500/20 hover:bg-red-500/80 text-red-200 hover:text-white rounded-full text-lg leading-none shadow-sm backdrop-blur-md transition-all border border-red-500/30" title="–û—Ç–º–µ–Ω–∏—Ç—å">
                                √ó
                            </button>
                        </div>
                    </div>
                    {!isBreak && <div className="text-black/80 text-[10px] truncate drop-shadow-sm">{booking.services}</div>}
                </div>
            );
        };

        const handleChange = (e, field) => { setEditData({...editData, [field]: e.target.value}); };
        const handleArrayTextChange = (e, field) => { setEditData({...editData, [field]: e.target.value.split('\n')}); };
        
        const handleStoryPropChange = (index, field, value) => {
          const newStories = [...editData.stories];
          newStories[index] = { ...newStories[index], [field]: value };
          setEditData({...editData, stories: newStories});
        };

        const moveStory = (index, direction) => {
          triggerHaptic();
          const newStories = [...editData.stories];
          if (direction === 'up' && index > 0) {
            [newStories[index - 1], newStories[index]] = [newStories[index], newStories[index - 1]];
          } else if (direction === 'down' && index < newStories.length - 1) {
            [newStories[index + 1], newStories[index]] = [newStories[index], newStories[index + 1]];
          }
          setEditData({...editData, stories: newStories});
        };

        const handleServiceChange = (index, field, value) => {
          const newServices = [...editData.services];
          newServices[index][field] = value;
          setEditData({...editData, services: newServices});
        };

        const moveService = (index, direction) => {
          triggerHaptic();
          const newServices = [...editData.services];
          if (direction === 'up' && index > 0) {
            [newServices[index - 1], newServices[index]] = [newServices[index], newServices[index - 1]];
          } else if (direction === 'down' && index < newServices.length - 1) {
            [newServices[index + 1], newServices[index]] = [newServices[index], newServices[index + 1]];
          }
          setEditData({...editData, services: newServices});
        };

        const addService = () => {
          triggerHaptic();
          setEditData({...editData, services: [...editData.services, { id: 's'+Date.now(), name: '', defaultTime: 30, icon: '‚ú®' }]});
        };
        const removeService = (index) => {
          triggerHaptic();
          const newServices = [...editData.services];
          newServices.splice(index, 1);
          setEditData({...editData, services: newServices});
        };

        const handleAddonChange = (index, field, value) => {
          const newAddons = [...editData.addons];
          newAddons[index][field] = value;
          setEditData({...editData, addons: newAddons});
        };
        const addAddon = () => {
          triggerHaptic();
          setEditData({...editData, addons: [...editData.addons, { id: 'a'+Date.now(), name: '', price: 100, icon: '‚ûï' }]});
        };
        const removeAddon = (index) => {
          triggerHaptic();
          const newAddons = [...editData.addons];
          newAddons.splice(index, 1);
          setEditData({...editData, addons: newAddons});
        };

        const approveReview = async (reviewId) => {
          triggerHaptic();
          const updatedReviews = editData.reviews.map(r => 
            r.id === reviewId ? { ...r, approved: true, admin_id: ADMIN_TG_ID } : r
          );
          const newEditData = {...editData, reviews: updatedReviews};
          
          setEditData(newEditData);
          setAppData(newEditData);
          await syncToFirebase(newEditData);
          localStorage.setItem('electroAppData', JSON.stringify(newEditData));
          showToast("–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω! ‚úÖ");
        };

        const deleteReviewAdmin = async (reviewId) => {
          triggerHaptic();
          if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤ –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
          const updatedReviews = editData.reviews.filter(r => r.id !== reviewId);
          const newEditData = {...editData, reviews: updatedReviews};
          
          setEditData(newEditData);
          setAppData(newEditData);
          await syncToFirebase(newEditData);
          localStorage.setItem('electroAppData', JSON.stringify(newEditData));
          showToast("–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω. üóëÔ∏è");
        };

        const handleClientChange = (tgId, field, value) => {
           const newClients = [...(editData.clients || [])];
           const cIdx = newClients.findIndex(c => c.tgId === tgId);
           if(cIdx !== -1) {
               newClients[cIdx] = { ...newClients[cIdx], [field]: value };
               setEditData({...editData, clients: newClients});
               saveClientToFirebase(newClients[cIdx]);
           }
        };

        const deleteClientAdmin = async (tgId) => {
          triggerHaptic();
          if(!confirm("–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –±–∞–∑—ã –Ω–∞–≤—Å–µ–≥–¥–∞? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –µ–≥–æ –∏—Å—Ç–æ—Ä–∏—é –æ–ø–ª–∞—Ç.")) return;
          
          const clientObj = editData.clients.find(c => c.tgId === tgId);
          const clientBookings = bookingsList.filter(b => {
             if (!clientObj) return false;
             const matchTgId = clientObj.tgId && b.tgId === clientObj.tgId;
             const matchUsername = clientObj.username && b.clientContact && b.clientContact.includes(clientObj.username);
             const matchPhone = clientObj.phone && b.phone && b.phone === clientObj.phone;
             const matchName = (b.clientName === clientObj.customName) || (b.clientName === clientObj.originalName);
             return matchTgId || matchUsername || matchPhone || matchName;
          });

          const bookingIdsToDelete = clientBookings.map(b => b.id);
          setBookingsList(prev => prev.filter(b => !bookingIdsToDelete.includes(b.id)));

          if(db) {
             bookingIdsToDelete.forEach(id => db.collection("bookings").doc(id).delete().catch(console.error));
          }

          const newClients = editData.clients.filter(c => c.tgId !== tgId);
          const newEditData = {...editData, clients: newClients};
          setEditData(newEditData);
          setAppData(newEditData);
          
          deleteClientFromFirebase(tgId);
          await syncToFirebase(newEditData);
          localStorage.setItem('electroAppData', JSON.stringify(newEditData));
          showToast("–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω! üóëÔ∏è");
        };

        const handleAddManualClient = async () => {
           if(!newClientName) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
           triggerHaptic();

           const matches = bookingsList.filter(b => {
               const matchUsername = newClientContact && b.clientContact && b.clientContact.includes(newClientContact);
               const matchName = newClientName && b.clientName === newClientName;
               const matchPhone = newClientPhone && b.phone === newClientPhone;
               return matchUsername || matchName || matchPhone;
           });
           const calcVisits = matches.length;
           const calcSpent = matches.reduce((sum, b) => sum + (b.actualPrice !== undefined && b.actualPrice !== null ? b.actualPrice : b.price), 0);

           const client = {
               tgId: 'manual_' + Date.now(),
               originalName: newClientName,
               customName: newClientName,
               username: newClientContact,
               phone: newClientPhone,
               visits: calcVisits,
               totalSpent: calcSpent,
               isBlacklisted: false,
               firstVisit: new Date().toISOString()
           };

           const updatedClients = [...(editData.clients || []), client];
           const newEditData = { ...editData, clients: updatedClients };
           setEditData(newEditData);
           setAppData(newEditData);
           
           saveClientToFirebase(client);
           await syncToFirebase(newEditData);
           localStorage.setItem('electroAppData', JSON.stringify(newEditData));

           setNewClientName('');
           setNewClientContact('');
           setNewClientPhone('');
           setShowAddClient(false);
           showToast("–ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É! ‚úÖ");
        };

        const saveChanges = async () => {
          triggerHaptic();
          setIsSaving(true);
          setAppData(editData);
          await syncToFirebase(editData);
          localStorage.setItem('electroAppData', JSON.stringify(editData));
          setIsSaving(false);
          showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ‚úì");
        };

        const allReviews = [...(editData.reviews || [])].sort((a,b) => new Date(b.date) - new Date(a.date));
        const allClients = [...(editData.clients || [])].sort((a,b) => (b.totalSpent || 0) - (a.totalSpent || 0));
        
        const filteredClients = allClients.filter(c =>
            (c.customName && c.customName.toLowerCase().includes(clientSearch.toLowerCase())) ||
            (c.originalName && c.originalName.toLowerCase().includes(clientSearch.toLowerCase())) ||
            (c.username && c.username.toLowerCase().includes(clientSearch.toLowerCase())) ||
            (c.phone && c.phone.includes(clientSearch))
        );

        const unapprovedCount = allReviews.filter(r => !r.approved).length;

        const currentMonthIdx = new Date().getMonth();
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
        const currentMonthName = monthNames[currentMonthIdx];
        const shortMonthNames = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
        const currentShortMonthName = shortMonthNames[currentMonthIdx];
        
        const currentMonthRevenue = bookingsList.reduce((sum, b) => {
            const bMonth = b.date ? b.date.split(' ')[1] : '';
            if (bMonth === currentShortMonthName && b.actualPrice !== undefined && b.actualPrice !== null && b.actualPrice !== '') {
                return sum + Number(b.actualPrice);
            }
            return sum;
        }, 0);

        return (
          <div className="min-h-[100dvh] w-full bg-[#0a0a0a] p-4 pb-32 animate-[fadeIn_0.3s_ease-in-out]">
            
            {adminSubView === 'main' ? (
              <>
                {/* –ó–ê–ì–û–õ–û–í–û–ö –ò –í–ö–õ–ê–î–ö–ò */}
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <Icon name="Settings" className="w-8 h-8 text-[#C89D7C]" />
                    <h2 className="text-2xl font-bold text-white">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
                  </div>
                </div>

                <div className="flex bg-[#1A1A1A] rounded-xl p-1 mb-6 border border-gray-700">
                  <button onClick={() => {triggerHaptic(); setAdminTab('settings');}} className={`flex-1 py-2 rounded-lg text-[11px] sm:text-xs font-bold transition-colors ${adminTab === 'settings' ? 'bg-[#C89D7C] text-black' : 'text-gray-400'}`}>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                  <button onClick={() => {triggerHaptic(); setAdminTab('calendar');}} className={`flex-1 py-2 rounded-lg text-[11px] sm:text-xs font-bold transition-colors ${adminTab === 'calendar' ? 'bg-[#C89D7C] text-black' : 'text-gray-400'}`}>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                  <button onClick={() => {triggerHaptic(); setAdminTab('clients');}} className={`flex-1 py-2 rounded-lg text-[11px] sm:text-xs font-bold transition-colors ${adminTab === 'clients' ? 'bg-[#C89D7C] text-black' : 'text-gray-400'}`}>–ö–ª–∏–µ–Ω—Ç—ã</button>
                </div>

                {adminTab === 'settings' && (
                  <div className="space-y-4">
                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-xs text-gray-400 mb-1">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –º–∏–Ω—É—Ç—ã (‚ÇΩ)</label>
                      <input type="number" value={editData.pricePerMinute} onChange={(e) => handleChange(e, 'pricePerMinute')} className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm" />
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-xs text-gray-400 mb-1">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (URL)</label>
                      <input value={editData.photoUrl} onChange={(e) => handleChange(e, 'photoUrl')} className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm" />
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-xs text-gray-400 mb-1">–ò–º—è</label>
                      <input value={editData.name} onChange={(e) => handleChange(e, 'name')} className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm" />
                      
                      <label className="block text-xs text-gray-400 mt-3 mb-1">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ú–∞—Å—Ç–µ—Ä...)</label>
                      <input value={editData.profession} onChange={(e) => handleChange(e, 'profession')} className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm" />
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-xs text-gray-400 mb-1">–ê–¥—Ä–µ—Å</label>
                      <input value={editData.address} onChange={(e) => handleChange(e, 'address')} className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm" />
                      
                      <label className="block text-xs text-gray-400 mt-3 mb-1">–û–±–æ –º–Ω–µ</label>
                      <textarea value={editData.about} onChange={(e) => handleChange(e, 'about')} rows="3" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm"></textarea>
                      
                      <label className="block text-xs text-gray-400 mt-3 mb-1">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É (Yandex/Google)</label>
                      <input value={editData.mapLink || ''} onChange={(e) => handleChange(e, 'mapLink')} placeholder="https://..." className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm" />
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-sm font-bold text-white mb-3">–ù–∞–∑–≤–∞–Ω–∏—è 5 –∫—Ä—É–∂–æ—á–∫–æ–≤ (–°—Ç–æ—Ä–∏–∑)</label>
                      <p className="text-xs text-gray-400 mb-4">–û—Å—Ç–∞–≤—å –∏–º—è –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∫—Ä—É–∂–æ–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π.</p>
                      {editData.stories.map((story, i) => (
                        <div key={i} className="bg-[#1A1A1A] border border-gray-700 rounded-xl p-3 flex flex-col gap-2 mb-3">
                          <div className="flex justify-between items-center">
                            <label className="text-[10px] text-[#C89D7C] font-bold uppercase tracking-wider">–ö—Ä—É–∂–æ–∫ {i+1}</label>
                            <div className="flex gap-3 px-1">
                              <button onClick={() => moveStory(i, 'up')} disabled={i === 0} className={`text-lg leading-none font-bold ${i === 0 ? 'text-gray-700 cursor-not-allowed' : 'text-[#C89D7C] hover:text-white transition-colors'}`}>‚Üë</button>
                              <button onClick={() => moveStory(i, 'down')} disabled={i === editData.stories.length - 1} className={`text-lg leading-none font-bold ${i === editData.stories.length - 1 ? 'text-gray-700 cursor-not-allowed' : 'text-[#C89D7C] hover:text-white transition-colors'}`}>‚Üì</button>
                            </div>
                          </div>
                          <input 
                            value={story.name} 
                            onChange={(e) => handleStoryPropChange(i, 'name', e.target.value)} 
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –û—Ç–∑—ã–≤—ã)" 
                            className="w-full bg-[#2A2A2A] rounded-lg p-2 text-white text-sm focus:outline-none focus:border-[#C89D7C] border border-transparent transition-colors" 
                          />
                          
                          {story.name.trim() !== '' && (
                            <div className="animate-[fadeIn_0.3s_ease-out] flex flex-col gap-2">
                              <select 
                                value={story.type} 
                                onChange={(e) => handleStoryPropChange(i, 'type', e.target.value)} 
                                className="w-full bg-[#2A2A2A] rounded-lg p-2 text-white text-sm border border-transparent focus:outline-none focus:border-[#C89D7C]"
                              >
                                <option value="reviews">‚≠ê –°–∏—Å—Ç–µ–º–Ω—ã–µ –û—Ç–∑—ã–≤—ã</option>
                                <option value="insta">üì± –ò–Ω—Å—Ç–∞-—Å—Ç–æ—Ä–∏–∑ (–§—É–ª–ª—Å–∫—Ä–∏–Ω)</option>
                                <option value="gallery">üñºÔ∏è –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –ì–∞–ª–µ—Ä–µ—è</option>
                                <option value="page">üìÑ –¢–µ–∫—Å—Ç–æ–≤–∞—è –°—Ç—Ä–∞–Ω–∏—á–∫–∞</option>
                              </select>
                              
                              {(story.type === 'insta' || story.type === 'gallery') && (
                                 <textarea 
                                   value={(story.images || []).join('\n')} 
                                   onChange={(e) => handleStoryPropChange(i, 'images', e.target.value.split('\n'))} 
                                   placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)" 
                                   rows="3" 
                                   className="w-full bg-[#2A2A2A] rounded-lg p-2 text-white text-xs border border-transparent focus:outline-none focus:border-[#C89D7C]"
                                 ></textarea>
                              )}
                              
                              {story.type === 'page' && (
                                 <textarea 
                                   value={story.content || ''} 
                                   onChange={(e) => handleStoryPropChange(i, 'content', e.target.value)} 
                                   placeholder="–¢–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã..." 
                                   rows="4" 
                                   className="w-full bg-[#2A2A2A] rounded-lg p-2 text-white text-sm border border-transparent focus:outline-none focus:border-[#C89D7C]"
                                 ></textarea>
                              )}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-sm font-bold text-white mb-1">–°–≤–æ–±–æ–¥–Ω—ã–µ –¥–∞—Ç—ã –∏ –æ–∫–æ—à–∫–∏</label>
                      <p className="text-xs text-gray-400 mb-4">–ù–∞–∂–º–∏ –Ω–∞ –¥–µ–Ω—å, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–≥–æ –≤—Ä–µ–º—è.</p>
                      
                      <div className="grid grid-cols-7 gap-1 mb-4">
                        {globalCalendarDays.map((item, idx) => {
                          const isSelected = editData.dates.some(d => d.date === item.date);
                          const isEditingThis = adminSelectedDateObj?.date === item.date;
                          return (
                            <div key={idx} onClick={() => { triggerHaptic(); setAdminSelectedDateObj(item); setNewTimeVal(''); }} 
                                 className={`flex flex-col items-center justify-center py-2 rounded-lg cursor-pointer transition-colors border-2 
                                 ${isSelected ? 'bg-[#C89D7C] text-black border-[#C89D7C]' : 'bg-[#1A1A1A] text-gray-500 border-gray-800'}
                                 ${isEditingThis ? 'ring-2 ring-white scale-105' : ''}`}>
                              <span className="text-[10px] leading-none mb-1 opacity-80">{item.day}</span>
                              <span className="text-sm font-bold leading-none">{item.date.split(' ')[0]}</span>
                            </div>
                          );
                        })}
                      </div>

                      {adminSelectedDateObj && (() => {
                        const dateEntryIndex = editData.dates.findIndex(d => d.date === adminSelectedDateObj.date);
                        const isWorkingDay = dateEntryIndex !== -1;

                        if (!isWorkingDay) {
                          return (
                            <div className="animate-[fadeIn_0.3s_ease-out] bg-[#1A1A1A] p-4 rounded-xl border border-gray-700 text-center">
                              <p className="text-white font-bold mb-1">{adminSelectedDateObj.date}, {adminSelectedDateObj.day}</p>
                              <p className="text-gray-500 text-xs mb-3">–°–µ–π—á–∞—Å —ç—Ç–æ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å.</p>
                              <button onClick={() => {
                                triggerHaptic();
                                const newDates = [...editData.dates, { ...adminSelectedDateObj, slots: ['10:00', '12:00', '14:00', '16:00'] }];
                                newDates.sort((a, b) => {
                                   const idxA = globalCalendarDays.findIndex(c => c.date === a.date);
                                   const idxB = globalCalendarDays.findIndex(c => c.date === b.date);
                                   return (idxA !== -1 && idxB !== -1) ? idxA - idxB : 0;
                                });
                                setEditData({...editData, dates: newDates});
                              }} className="bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black px-4 py-2 rounded-lg font-bold text-sm">
                                –°–¥–µ–ª–∞—Ç—å —Ä–∞–±–æ—á–∏–º
                              </button>
                            </div>
                          );
                        }

                        const entry = editData.dates[dateEntryIndex];
                        return (
                          <div className="animate-[fadeIn_0.3s_ease-out] bg-[#1A1A1A] p-4 rounded-xl border border-[#C89D7C]/50 relative">
                            <button onClick={() => {
                              triggerHaptic();
                              const newDates = [...editData.dates];
                              newDates.splice(dateEntryIndex, 1);
                              setEditData({...editData, dates: newDates});
                            }} className="absolute top-3 right-3 text-red-400 text-xs font-bold bg-red-400/10 px-2 py-1 rounded-md">–°–¥–µ–ª–∞—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–º</button>
                            
                            <p className="text-[#C89D7C] font-bold mb-3">{adminSelectedDateObj.date}, {adminSelectedDateObj.day}</p>
                            
                            <div className="flex flex-wrap gap-2 mb-4">
                              {entry.slots.length === 0 && <span className="text-xs text-gray-500">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</span>}
                              {entry.slots.map((time, idx) => (
                                <div key={idx} className="bg-[#2A2A2A] border border-[#C89D7C]/30 rounded-lg px-2 py-1 flex items-center gap-1">
                                  <span className="text-sm text-white font-medium">{time}</span>
                                  <button onClick={() => {
                                    triggerHaptic();
                                    const newDates = [...editData.dates];
                                    newDates[dateEntryIndex].slots.splice(idx, 1);
                                    setEditData({...editData, dates: newDates});
                                  }} className="text-red-400 hover:text-red-300 ml-1">√ó</button>
                                </div>
                              ))}
                            </div>

                            <div className="flex gap-2">
                              <GlassTimePicker value={newTimeVal} onChange={setNewTimeVal} />
                              <button onClick={() => {
                                if(!newTimeVal) return;
                                triggerHaptic();
                                const newDates = [...editData.dates];
                                newDates[dateEntryIndex].slots.push(newTimeVal);
                                newDates[dateEntryIndex].slots.sort();
                                setEditData({...editData, dates: newDates});
                                setNewTimeVal('');
                              }} className="bg-[#C89D7C] text-black px-4 py-2 rounded-lg font-bold text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                          </div>
                        );
                      })()}
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-xs text-gray-400 mb-1">–ü–∞–º—è—Ç–∫–∞ (–∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                      <textarea 
                        value={editData.memo.join('\n')} 
                        onChange={(e) => handleArrayTextChange(e, 'memo')} 
                        rows="4" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-2 text-white text-sm"></textarea>
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-sm font-bold text-white mb-3">–£—Å–ª—É–≥–∏ (–ó–æ–Ω—ã)</label>
                      <div className="space-y-3 mb-3">
                        {editData.services.map((svc, idx) => (
                          <div key={idx} className="bg-[#1A1A1A] border border-gray-700 rounded-xl p-3 flex flex-col gap-2 relative">
                            <button onClick={() => removeService(idx)} className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full font-bold text-xs flex items-center justify-center shadow-lg z-10">√ó</button>
                            
                            <div className="flex justify-between items-center mb-1">
                              <label className="text-[10px] text-[#C89D7C] font-bold uppercase tracking-wider">–ó–æ–Ω–∞ {idx+1}</label>
                              <div className="flex gap-3 px-1">
                                <button onClick={() => moveService(idx, 'up')} disabled={idx === 0} className={`text-lg leading-none font-bold ${idx === 0 ? 'text-gray-700 cursor-not-allowed' : 'text-[#C89D7C] hover:text-white transition-colors'}`}>‚Üë</button>
                                <button onClick={() => moveService(idx, 'down')} disabled={idx === editData.services.length - 1} className={`text-lg leading-none font-bold ${idx === editData.services.length - 1 ? 'text-gray-700 cursor-not-allowed' : 'text-[#C89D7C] hover:text-white transition-colors'}`}>‚Üì</button>
                              </div>
                            </div>

                            <div className="flex gap-2 mb-2">
                              <input value={svc.icon} onChange={e => handleServiceChange(idx, 'icon', e.target.value)} className="w-12 text-center bg-[#2A2A2A] rounded-lg p-2 text-white text-sm" placeholder="‚ú®" />
                              <input value={svc.name} onChange={e => handleServiceChange(idx, 'name', e.target.value)} className="flex-1 bg-[#2A2A2A] rounded-lg p-2 text-white text-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã" />
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-xs text-gray-400">–í—Ä–µ–º—è:</span>
                              <GlassDurationPicker value={svc.defaultTime} onChange={val => handleServiceChange(idx, 'defaultTime', val)} />
                            </div>
                          </div>
                        ))}
                      </div>
                      <button onClick={addService} className="w-full bg-[#2A2A2A] border border-[#C89D7C]/30 text-[#C89D7C] py-2 rounded-xl text-sm font-bold">+ –î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—É</button>
                    </div>

                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <label className="block text-sm font-bold text-white mb-3">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–î–æ–ø—ã)</label>
                      <div className="space-y-3 mb-3">
                        {editData.addons.map((addon, idx) => (
                          <div key={idx} className="bg-[#1A1A1A] border border-gray-700 rounded-xl p-3 flex flex-col gap-2 relative">
                            <button onClick={() => removeAddon(idx)} className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full font-bold text-xs flex items-center justify-center shadow-lg">√ó</button>
                            <div className="flex gap-2">
                              <input value={addon.icon} onChange={e => handleAddonChange(idx, 'icon', e.target.value)} className="w-12 text-center bg-[#2A2A2A] rounded-lg p-2 text-white text-sm" placeholder="üßä" />
                              <input value={addon.name} onChange={e => handleAddonChange(idx, 'name', e.target.value)} className="flex-1 bg-[#2A2A2A] rounded-lg p-2 text-white text-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ø–∞" />
                            </div>
                            <div className="flex items-center gap-2 mt-2">
                              <span className="text-xs text-gray-400">–¶–µ–Ω–∞ (+‚ÇΩ):</span>
                              <input type="number" value={addon.price} onChange={e => handleAddonChange(idx, 'price', parseInt(e.target.value)||0)} className="w-24 bg-[#2A2A2A] rounded-lg p-1.5 text-white text-sm" />
                            </div>
                          </div>
                        ))}
                      </div>
                      <button onClick={addAddon} className="w-full bg-[#2A2A2A] border border-[#C89D7C]/30 text-[#C89D7C] py-2 rounded-xl text-sm font-bold">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø</button>
                    </div>
                  </div>
                )}
                
                {/* –í–ö–õ–ê–î–ö–ê –ö–õ–ò–ï–ù–¢–´ (–ú–ò–ù–ò-CRM) */}
                {adminTab === 'clients' && (
                   <div className="space-y-4 animate-[fadeIn_0.3s_ease-in-out]">
                     <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                       <button onClick={() => { triggerHaptic(); setShowAddClient(!showAddClient); }} className="w-full flex justify-between items-center text-sm font-bold text-white">
                          –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤—Ä—É—á–Ω—É—é {showAddClient ? <span className="text-[#C89D7C] text-lg">‚àí</span> : <span className="text-[#C89D7C] text-lg">+</span>}
                       </button>
                       {showAddClient && (
                          <div className="mt-4 pt-4 border-t border-white/10 animate-[fadeIn_0.3s_ease-in-out]">
                             <input value={newClientName} onChange={e=>setNewClientName(e.target.value)} placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-3 text-white text-sm mb-2 focus:outline-none focus:border-[#C89D7C]" />
                             <input value={newClientContact} onChange={e=>setNewClientContact(e.target.value)} placeholder="–ö–æ–Ω—Ç–∞–∫—Ç (–ù–∏–∫ –≤ –¢–ì)" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-3 text-white text-sm mb-2 focus:outline-none focus:border-[#C89D7C]" />
                             <input type="tel" value={newClientPhone} onChange={e=>setNewClientPhone(e.target.value)} placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-3 text-white text-sm mb-3 focus:outline-none focus:border-[#C89D7C]" />
                             <button onClick={handleAddManualClient} className="w-full bg-[#2A2A2A] text-[#C89D7C] hover:bg-[#C89D7C] hover:text-black py-3 rounded-xl font-bold transition-colors border border-[#C89D7C]/30 shadow-lg">
                                + –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                             </button>
                          </div>
                       )}
                     </div>

                     <div className="glass-card-dark p-3 rounded-2xl border border-green-500/30 bg-green-500/5 flex justify-between items-center shadow-inner mb-4">
                        <span className="text-sm font-bold text-gray-300">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ {currentMonthName.toLowerCase()}</span>
                        <span className="text-lg font-bold text-green-400">{currentMonthRevenue} ‚ÇΩ</span>
                     </div>

                     <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                       <h3 className="text-lg font-bold text-white mb-2">–ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ ({allClients.length})</h3>
                       <p className="text-xs text-gray-400 mb-4">–ò–∑–º–µ–Ω–∏ –∏–º—è, —á—Ç–æ–±—ã –æ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ. –û—Ç–ø—Ä–∞–≤—å –≤ –ß–°, —á—Ç–æ–±—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏.</p>
                       
                       <div className="relative mb-4">
                         <input 
                           value={clientSearch} 
                           onChange={e => setClientSearch(e.target.value)} 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, –Ω–∏–∫—É –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." 
                           className="w-full bg-[#1A1A1A] border border-gray-700 rounded-xl p-3 pl-10 text-white text-sm focus:outline-none focus:border-[#C89D7C] transition-colors shadow-inner" 
                         />
                         <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                         </div>
                       </div>

                       {filteredClients.length === 0 ? (
                          <p className="text-gray-500 text-center py-6 text-sm">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
                       ) : (
                          <div className="space-y-3">
                             {filteredClients.map((client, idx) => {
                                const clientBookings = bookingsList.filter(b => {
                                     const matchTgId = client.tgId && b.tgId === client.tgId;
                                     const matchUsername = client.username && b.clientContact && b.clientContact.includes(client.username);
                                     const matchPhone = client.phone && b.phone && b.phone === client.phone;
                                     const matchName = (b.clientName === client.customName) || (b.clientName === client.originalName);
                                     return matchTgId || matchUsername || matchPhone || matchName;
                                });

                                let realTotalSpent = 0;
                                const bookingsByMonth = {};
                                clientBookings.forEach(b => {
                                   const [d, m] = b.date ? b.date.split(' ') : ['', ''];
                                   const monthName = m || '–î—Ä—É–≥–æ–µ';
                                   if(!bookingsByMonth[monthName]) bookingsByMonth[monthName] = { total: 0, items: [] };
                                   bookingsByMonth[monthName].items.push(b);
                                   
                                   if (b.actualPrice !== undefined && b.actualPrice !== null && b.actualPrice !== '') {
                                       bookingsByMonth[monthName].total += Number(b.actualPrice);
                                       realTotalSpent += Number(b.actualPrice);
                                   }
                                });

                                return (
                                  <div key={idx} className={`relative bg-[#1A1A1A] p-4 rounded-2xl border transition-colors ${client.isBlacklisted ? 'border-red-500/50 bg-red-900/10' : 'border-white/10 hover:border-[#C89D7C]/50'}`}>
                                     <button 
                                       onClick={(e) => { e.stopPropagation(); deleteClientAdmin(client.tgId); }} 
                                       className="absolute top-2 right-2 text-gray-500 hover:text-white bg-white/5 hover:bg-red-500/80 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-colors shadow-sm"
                                       title="–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"
                                     >√ó</button>

                                     <div className="flex justify-between items-start mb-3 pt-1">
                                        <div className="flex-1 mr-3">
                                          <label className="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1 block">–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –§–ò–û</label>
                                          <input 
                                            value={client.customName || ''} 
                                            onChange={(e) => handleClientChange(client.tgId, 'customName', e.target.value)} 
                                            placeholder={client.originalName} 
                                            className="w-full bg-[#2A2A2A] rounded-lg p-2 text-white text-sm focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                                          />
                                        </div>
                                        <div className="text-right">
                                           <span className="text-[10px] text-gray-500 block mb-0.5">–§–∞–∫—Ç. –æ–ø–ª–∞—Ç–∞</span>
                                           <span className="text-[#C89D7C] font-bold text-base">{realTotalSpent} ‚ÇΩ</span>
                                        </div>
                                     </div>

                                     <div className="flex justify-between items-center mb-4">
                                        <div className="flex flex-col gap-1.5">
                                          <div className="text-xs text-gray-400">
                                            –¢–ì: {client.username ? (
                                              <a href={`https://t.me/${client.username.replace('@', '')}`} target="_blank" className="text-[#C89D7C] hover:text-white transition-colors font-medium ml-1">
                                                {client.username}
                                              </a>
                                            ) : (
                                              <span className="text-white font-medium ml-1">ID: {client.tgId}</span>
                                            )}
                                          </div>
                                          <div className="text-xs text-gray-400 flex items-center">
                                            –¢–µ–ª: <input value={client.phone || ''} onChange={(e) => handleClientChange(client.tgId, 'phone', e.target.value)} placeholder="–ù–µ —É–∫–∞–∑–∞–Ω" className="ml-1 bg-transparent border-b border-gray-700 focus:border-[#C89D7C] text-white w-24 focus:outline-none px-1 py-0.5 placeholder-gray-600 transition-colors" />
                                          </div>
                                        </div>
                                        <div className="text-xs text-gray-400 bg-black/30 px-2 py-1 rounded-md border border-white/5">
                                          –í–∏–∑–∏—Ç–æ–≤: <span className="text-white font-bold">{clientBookings.length > 0 ? clientBookings.length : (client.visits || 1)}</span>
                                        </div>
                                     </div>

                                     <div className="flex gap-2">
                                         <button 
                                           onClick={() => { triggerHaptic(); handleClientChange(client.tgId, 'isBlacklisted', !client.isBlacklisted); }} 
                                           className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all border ${client.isBlacklisted ? 'bg-red-500/20 text-red-400 border-red-500/30 hover:bg-red-500/30' : 'bg-[#2A2A2A] text-gray-400 border-transparent hover:text-red-400'}`}
                                         >
                                           {client.isBlacklisted ? '–£–±—Ä–∞—Ç—å –∏–∑ –ß–°' : '–í –ß–°'}
                                         </button>
                                         <button 
                                           onClick={() => { triggerHaptic(); setExpandedClientTgId(expandedClientTgId === client.tgId ? null : client.tgId); }} 
                                           className="flex-1 py-2 rounded-xl text-xs font-bold bg-[#C89D7C]/10 text-[#C89D7C] hover:bg-[#C89D7C]/20 border border-[#C89D7C]/30 transition-all flex items-center justify-center gap-1"
                                         >
                                           {expandedClientTgId === client.tgId ? '–°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é' : '–ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤'}
                                           <Icon name="ChevronLeft" className={`w-3 h-3 transition-transform ${expandedClientTgId === client.tgId ? 'rotate-90' : '-rotate-90'}`} />
                                         </button>
                                     </div>

                                     {/* –ò–°–¢–û–†–ò–Ø –í–ò–ó–ò–¢–û–í –ò –û–ü–õ–ê–¢–´ */}
                                     {expandedClientTgId === client.tgId && (
                                         <div className="mt-4 space-y-3 pt-3 border-t border-gray-700 animate-[fadeIn_0.3s_ease-out]">
                                           {Object.keys(bookingsByMonth).length === 0 ? (
                                               <p className="text-gray-500 text-xs text-center pb-2">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                                           ) : (
                                               Object.entries(bookingsByMonth).map(([mName, data]) => (
                                                   <div key={mName} className="bg-black/40 rounded-xl p-3 border border-white/5">
                                                       <div className="flex justify-between items-center mb-3">
                                                          <span className="text-sm font-bold text-white uppercase tracking-wider">{mName}</span>
                                                          <span className="text-xs font-bold bg-[#C89D7C] text-black px-2 py-0.5 rounded">–ò—Ç–æ–≥: {data.total} ‚ÇΩ</span>
                                                       </div>
                                                       <div className="space-y-3">
                                                          {data.items.map(b => (
                                                             <div key={b.id} className="text-xs text-gray-400 border-l-2 border-[#C89D7C] pl-2.5 py-1">
                                                                 <div className="flex justify-between text-white mb-1">
                                                                    <span className="font-medium">{b.date} –≤ {b.time}</span>
                                                                    <span className="bg-gray-800 px-1.5 rounded">{b.duration} –º–∏–Ω</span>
                                                                 </div>
                                                                 <div className="truncate mb-2 text-gray-500">{b.services}</div>
                                                                 <div className="flex items-center gap-2">
                                                                    <span className="text-[10px] uppercase font-bold tracking-wider">–§–∞–∫—Ç. –æ–ø–ª–∞—Ç–∞:</span>
                                                                    <div className="flex items-center gap-1">
                                                                      <input type="number" 
                                                                         defaultValue={b.actualPrice !== undefined && b.actualPrice !== null ? b.actualPrice : ''} 
                                                                         placeholder={b.price}
                                                                         onBlur={(e) => updateActualPrice(b.id, e.target.value)}
                                                                         className="bg-[#2A2A2A] border border-gray-600 rounded-md p-1 w-16 text-white text-center font-bold focus:border-[#C89D7C] focus:outline-none transition-colors placeholder-gray-500" 
                                                                      /> <span className="text-[#C89D7C] font-bold">‚ÇΩ</span>
                                                                    </div>
                                                                 </div>
                                                             </div>
                                                          ))}
                                                       </div>
                                                   </div>
                                               ))
                                           )}
                                         </div>
                                     )}

                                  </div>
                                );
                             })}
                          </div>
                       )}
                     </div>
                   </div>
                )}

                {adminTab === 'calendar' && (
                  <div className="space-y-4 animate-[fadeIn_0.3s_ease-in-out]">
                    
                    {/* –ö–ù–û–ü–ö–ê –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –û–ö–û–®–ï–ö –î–õ–Ø –°–¢–û–†–ò–ó */}
                    <button 
                      onClick={copyEmptySlotsToClipboard}
                      className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black py-3 rounded-2xl font-bold shadow-[0_5px_15px_rgba(200,157,124,0.3)] flex items-center justify-center gap-2 hover:opacity-90 transition-opacity"
                    >
                      <span className="text-xl">ü™Ñ</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏
                    </button>

                    {/* –ê–∫–∫–æ—Ä–¥–µ–æ–Ω –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–ø–∏—Å–∏ */}
                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <button onClick={() => { triggerHaptic(); setShowManualBooking(!showManualBooking); }} className="w-full flex justify-between items-center text-sm font-bold text-white">
                          –ó–∞–ø–∏—Å–∞—Ç—å –≤—Ä—É—á–Ω—É—é {showManualBooking ? <span className="text-[#C89D7C] text-lg">‚àí</span> : <span className="text-[#C89D7C] text-lg">+</span>}
                      </button>
                      
                      {showManualBooking && (
                        <div className="mt-4 pt-4 border-t border-white/10 animate-[fadeIn_0.3s_ease-in-out]">
                          <input value={manualName} onChange={e=>setManualName(e.target.value)} placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∫–∏ (–∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç)" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-3 text-white text-sm mb-2 focus:outline-none focus:border-[#C89D7C]" />
                          <input value={manualService} onChange={e=>setManualService(e.target.value)} placeholder="–£—Å–ª—É–≥–∞ (–Ω–∞–ø—Ä. –ë–∏–∫–∏–Ω–∏ 60 –º–∏–Ω)" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-3 text-white text-sm mb-2 focus:outline-none focus:border-[#C89D7C]" />
                          <input type="tel" value={manualPhone} onChange={e=>setManualPhone(e.target.value)} placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" className="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg p-3 text-white text-sm mb-2 focus:outline-none focus:border-[#C89D7C]" />
                          
                          <div className="flex gap-2 mb-3">
                            <GlassSelect value={manualDate} options={dateOptions} onChange={(val) => { setManualDate(val); setManualTime(''); }} placeholder="–î–∞—Ç–∞" />
                            <GlassTimePicker value={manualTime} onChange={setManualTime} disabled={!manualDate} />
                          </div>
                          
                          <div className="flex gap-2 mt-3">
                            <button onClick={addManualBooking} className="flex-[2] bg-[#2A2A2A] text-[#C89D7C] hover:bg-[#C89D7C] hover:text-black py-3 rounded-xl font-bold transition-colors border border-[#C89D7C]/30 shadow-lg">
                               + –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button onClick={addBreak} className="flex-1 bg-gray-700 text-white hover:bg-gray-600 py-3 rounded-xl font-bold transition-colors border border-gray-500 shadow-lg">
                               ‚òï –ü–µ—Ä–µ—Ä—ã–≤
                            </button>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* iOS –ö–í–ê–î–†–ê–¢–ù–´–ô –ö–ê–õ–ï–ù–î–ê–†–¨ */}
                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-white capitalize">
                          {calendarMonth.toLocaleString('ru-RU', { month: 'long', year: 'numeric' })}
                        </h3>
                        <div className="flex gap-3">
                          <button onClick={() => { triggerHaptic(); setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1)); }} className="text-[#C89D7C] hover:text-white px-2 py-1 text-xl leading-none transition-colors">‚Äπ</button>
                          <button onClick={() => { triggerHaptic(); setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1)); }} className="text-[#C89D7C] hover:text-white px-2 py-1 text-xl leading-none transition-colors">‚Ä∫</button>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-7 mb-2 text-center text-[10px] text-gray-500 font-bold uppercase">
                        <div>–ü</div><div>–í</div><div>–°</div><div>–ß</div><div>–ü</div><div>–°</div><div>–í</div>
                      </div>
                      
                      <div className="grid grid-cols-7 gap-y-3 text-center">
                        {getMonthGrid(calendarMonth).map((cell, idx) => {
                          const dateStr = formatDateStr(cell.dateObj);
                          const isSelected = adminCalendarDate === dateStr;
                          const isToday = cell.dateObj.toDateString() === new Date().toDateString();
                          const hasBookings = bookingsList.some(b => b.date === dateStr);

                          return (
                            <div key={idx}
                                 onClick={() => { triggerHaptic(); setAdminCalendarDate(dateStr); }}
                                 className="flex flex-col items-center justify-start relative h-12 pt-1 mb-1"
                            >
                              <div className={`w-8 h-8 flex items-center justify-center rounded-full cursor-pointer transition-all z-10
                                ${!cell.isCurrentMonth ? 'text-gray-600' : 'text-white'}
                                ${isSelected ? 'bg-[#C89D7C] text-black font-bold shadow-[0_0_10px_rgba(200,157,124,0.5)]' : 'hover:bg-white/10'}
                                ${isToday && !isSelected ? 'border border-[#C89D7C]/50 text-[#C89D7C]' : ''}`}
                              >
                                <span className="text-sm">{cell.dateObj.getDate()}</span>
                              </div>
                              {hasBookings && (
                                <div className="absolute bottom-1 w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.6)] z-0"></div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    {/* TIMELINE VIEW (–õ–ï–ù–¢–ê –í–†–ï–ú–ï–ù–ò) */}
                    <div className="glass-card-dark p-4 rounded-2xl border border-white/10 overflow-hidden relative">
                      <h3 className="text-sm font-bold text-white mb-3">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: <span className="text-[#C89D7C]">{adminCalendarDate}</span></h3>

                      {/* –°–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ */}
                      <div className="relative bg-[#121212] rounded-xl border border-gray-800 h-[500px] overflow-y-auto hide-scrollbar">
                        <div className="relative" style={{height: `${13 * 60}px`}}>
                            {/* –õ–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏ */}
                            {hoursList.map((h, i) => (
                                <div key={h} className="absolute w-full flex items-start border-t border-gray-800/60" style={{top: `${i*60}px`, height: '60px'}}>
                                    <span className="text-[10px] text-gray-500 w-12 pl-2 mt-1 font-medium">{h}:00</span>
                                </div>
                            ))}

                            {/* –ë–ª–æ–∫–∏ —Å –∑–∞–ø–∏—Å—è–º–∏ */}
                            {loadingBookings ? (
                               <div className="absolute inset-0 flex items-center justify-center bg-black/50 text-[#C89D7C] text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                            ) : (
                              bookingsList.filter(b => b.date === adminCalendarDate).map(b => (
                                  <SimpleBookingBlock 
                                      key={b.id} 
                                      booking={b} 
                                      hourHeight={60} 
                                      onEdit={openEditBooking}
                                      onCancel={cancelBooking}
                                      onRemind={sendReminder}
                                  />
                              ))
                            )}
                        </div>
                      </div>
                      <p className="text-[10px] text-gray-500 mt-3 text-center uppercase tracking-widest font-bold">üí° –ù–∞–∂–º–∏ –Ω–∞ –±–ª–æ–∫ –∑–∞–ø–∏—Å–∏, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è</p>
                    </div>
                  </div>
                )}
              </>
            ) : (
              /* –†–ï–ñ–ò–ú –ú–û–î–ï–†–ê–¶–ò–ò –û–¢–ó–´–í–û–í */
              <div className="space-y-4 animate-[fadeIn_0.3s_ease-in-out]">
                <h2 className="text-2xl font-bold text-white mb-6">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</h2>
                {allReviews.length === 0 ? (
                  <p className="text-xs text-gray-500">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                ) : (
                  allReviews.map(rev => (
                    <div key={rev.id} className={`p-5 rounded-2xl border ${rev.approved ? 'border-green-500/30 bg-green-500/10' : 'border-[#C89D7C]/50 bg-[#C89D7C]/10'} relative glass-card-dark`}>
                      <div className="flex justify-between items-start mb-2">
                        <span className="font-bold text-white text-base">{rev.name} <span className="text-[#C89D7C]">({rev.rating}‚≠ê)</span></span>
                        <span className={`text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider ${rev.approved ? 'bg-green-500/20 text-green-400' : 'bg-[#C89D7C]/20 text-[#C89D7C]'}`}>
                          {rev.approved ? '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '‚è≥ –ú–æ–¥–µ—Ä–∞—Ü–∏—è'}
                        </span>
                      </div>
                      <p className="text-sm text-gray-300 mb-4">{rev.text}</p>
                      <div className="flex gap-2">
                        {!rev.approved && (
                          <button onClick={() => approveReview(rev.id)} className="flex-1 bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-xl text-sm font-bold transition-colors shadow-lg">
                            –û–¥–æ–±—Ä–∏—Ç—å
                          </button>
                        )}
                        <button onClick={() => deleteReviewAdmin(rev.id)} className="flex-1 bg-red-600/80 hover:bg-red-500 text-white px-3 py-2 rounded-xl text-sm font-bold transition-colors shadow-lg">
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}

            {/* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ö–ò (STICKY BAR) */}
            <div className="fixed bottom-0 left-0 right-0 p-3 bg-[#1A1A1A]/80 backdrop-blur-xl border-t border-white/5 max-w-md mx-auto z-50 flex gap-2">
              {adminSubView === 'main' ? (
                <>
                  <button onClick={() => {triggerHaptic(); setAdminSubView('mod');}} className="flex-[1] bg-[#2A2A2A] text-[#C89D7C] rounded-xl font-bold py-2 text-sm border border-white/5 relative hover:bg-[#333] transition-colors shadow-sm">
                    –ú–æ–¥.
                    {unapprovedCount > 0 && (
                      <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-bold shadow-md animate-pulse">
                        {unapprovedCount}
                      </span>
                    )}
                  </button>
                  <button onClick={saveChanges} disabled={isSaving} className="flex-[2] bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold py-2 text-sm rounded-xl shadow-md disabled:opacity-50 hover:opacity-90 transition-opacity">
                    {isSaving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                  </button>
                  <button onClick={() => {triggerHaptic(); setActiveTab('main');}} className="flex-[1] bg-red-500/10 text-red-400 font-bold py-2 text-sm rounded-xl border border-red-500/20 hover:bg-red-500/20 transition-colors shadow-sm">
                    –ó–∞–∫—Ä—ã—Ç—å
                  </button>
                </>
              ) : (
                <>
                  <button onClick={() => {triggerHaptic(); setAdminSubView('main');}} className="flex-[1] bg-[#2A2A2A] text-white rounded-xl font-bold py-2 text-sm border border-white/5 hover:bg-[#333] transition-colors shadow-sm">
                    –ù–∞–∑–∞–¥
                  </button>
                  <button onClick={saveChanges} disabled={isSaving} className="flex-[2] bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold py-2 text-sm rounded-xl shadow-md disabled:opacity-50 hover:opacity-90 transition-opacity">
                    {isSaving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                  </button>
                </>
              )}
            </div>

          </div>
        );
      };

      return (
        <div className="max-w-md mx-auto min-h-[100dvh] w-full relative shadow-2xl bg-black/40 border-x border-white/5 overflow-hidden">
          
          {/* –¢–û–ß–ö–ê –°–¢–ê–¢–£–°–ê FIREBASE (–°–í–ï–¢–û–§–û–†) */}
          <div 
            className={`fixed top-4 right-4 w-2.5 h-2.5 rounded-full z-[60] transition-colors duration-500 ${dbConnected ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]'}`} 
            title={dbConnected ? "–û–±–ª–∞–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–ù–µ—Ç —Å–≤—è–∑–∏ —Å –æ–±–ª–∞–∫–æ–º"}
          ></div>

          {/* –í–°–ü–õ–´–í–ê–Æ–©–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (TOAST) */}
          {toastMsg && (
            <div className="fixed top-10 left-1/2 -translate-x-1/2 z-[100] bg-green-600/90 text-white px-6 py-3 rounded-full shadow-[0_5px_20px_rgba(34,197,94,0.4)] backdrop-blur-md font-bold text-sm animate-[fadeIn_0.3s_ease-out] border border-green-400/30 whitespace-nowrap">
              {toastMsg}
            </div>
          )}

          {activeTab === 'main' && renderMain()}
          {activeTab === 'booking' && renderBooking()}
          {activeTab === 'success' && renderSuccess()}
          {activeTab === 'admin' && renderAdminPanel()}
          {activeTab === 'reviews' && renderReviews()}
          {activeTab === 'story_page' && renderStoryPage()}

          {/* –í–°–ü–õ–´–í–ê–Æ–©–ê–Ø –ì–ê–õ–ï–†–ï–Ø (–ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û) */}
          {viewingStory && viewingStory.type === 'gallery' && (
            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-[fadeIn_0.3s_ease-out]">
              <div className="bg-[#1A1A1A] border border-[#C89D7C]/30 rounded-3xl w-full max-w-sm overflow-hidden relative shadow-2xl">
                <button onClick={() => { triggerHaptic(); setViewingStory(null); }} className="absolute top-3 right-3 z-10 w-8 h-8 bg-black/50 rounded-full text-white flex items-center justify-center font-bold text-xl pb-1">√ó</button>
                <div className="w-full aspect-[3/4] max-h-[70vh] bg-black relative">
                  {viewingStory.images[storyImageIdx] ? (
                    <img src={viewingStory.images[storyImageIdx]} className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-500">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                  )}
                  {storyImageIdx > 0 && (
                    <button onClick={() => { triggerHaptic(); setStoryImageIdx(prev=>prev-1); }} className="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center font-bold">‚Äπ</button>
                  )}
                  {storyImageIdx < viewingStory.images.length - 1 && (
                    <button onClick={() => { triggerHaptic(); setStoryImageIdx(prev=>prev+1); }} className="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center font-bold">‚Ä∫</button>
                  )}
                </div>
                <div className="p-4 text-center">
                  <h3 className="font-bold text-white mb-1">{viewingStory.name}</h3>
                  <p className="text-xs text-gray-400">{storyImageIdx + 1} / {viewingStory.images.length || 0}</p>
                </div>
              </div>
            </div>
          )}

          {/* –ò–ù–°–¢–ê-–°–¢–û–†–ò–ó (–ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù) */}
          {viewingStory && viewingStory.type === 'insta' && (
            <div className="fixed inset-0 z-[100] bg-black flex flex-col animate-[fadeIn_0.2s_ease-out]">
              <div className="absolute top-0 left-0 right-0 p-4 flex gap-1 z-20 pt-6">
                {viewingStory.images.map((_, i) => (
                  <div key={i} className={`h-1 flex-1 rounded-full ${i === storyImageIdx ? 'bg-white' : 'bg-white/30'}`} />
                ))}
              </div>
              <button onClick={() => { triggerHaptic(); setViewingStory(null); }} className="absolute top-10 right-4 z-20 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center font-bold text-xl pb-1">√ó</button>
              
              <div className="flex-1 relative flex items-center justify-center">
                {viewingStory.images[storyImageIdx] ? (
                  <img src={viewingStory.images[storyImageIdx]} className="w-full h-full object-cover" />
                ) : (
                  <span className="text-gray-500">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                )}
                
                {/* –ù–µ–≤–∏–¥–∏–º—ã–µ –∑–æ–Ω—ã –¥–ª—è —Ç–∞–ø–æ–≤ */}
                <div className="absolute top-0 left-0 w-1/3 h-full z-10" onClick={() => { 
                  triggerHaptic(); 
                  if (storyImageIdx > 0) setStoryImageIdx(storyImageIdx - 1); 
                }}></div>
                <div className="absolute top-0 right-0 w-2/3 h-full z-10" onClick={() => { 
                  triggerHaptic(); 
                  if (storyImageIdx < viewingStory.images.length - 1) setStoryImageIdx(storyImageIdx + 1); 
                  else setViewingStory(null); 
                }}></div>
              </div>
            </div>
          )}

          {showMemo && renderMemoModal()}

          {/* –í–°–ü–õ–´–í–ê–Æ–©–ï–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ó–ê–ü–ò–°–ò */}
          {editingBooking && (
            <div className="fixed inset-0 z-[110] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-[fadeIn_0.3s_ease-out]">
              <div className="bg-[#1A1A1A] border border-[#C89D7C]/30 rounded-3xl w-full max-w-sm p-6 shadow-[0_0_40px_rgba(200,157,124,0.15)]">
                <h3 className="text-xl font-bold text-white mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input 
                   type="text" 
                   value={editBName} 
                   onChange={e => setEditBName(e.target.value)} 
                   className="w-full bg-[#2A2A2A] rounded-xl p-3 text-white text-sm mb-4 focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                />

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–ó–æ–Ω—ã (–£—Å–ª—É–≥–∏)</label>
                <input 
                   type="text" 
                   value={editBServices} 
                   onChange={e => setEditBServices(e.target.value)} 
                   className="w-full bg-[#2A2A2A] rounded-xl p-3 text-white text-sm mb-4 focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                />

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–î–∞—Ç–∞</label>
                <div className="mb-4">
                   <GlassSelect value={editBDate} options={dateOptions} onChange={setEditBDate} placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" />
                </div>

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–í—Ä–µ–º—è</label>
                <div className="mb-4">
                   <GlassTimePicker value={editBTime} onChange={setEditBTime} />
                </div>

                <label className="block text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç)</label>
                <input 
                   type="number" step="15" 
                   value={editBDuration} 
                   onChange={e => setEditBDuration(e.target.value === '' ? '' : Number(e.target.value))} 
                   className="w-full bg-[#2A2A2A] rounded-xl p-3 text-white text-sm mb-6 focus:outline-none focus:border-[#C89D7C] border border-transparent" 
                />

                <div className="flex gap-3">
                  <button onClick={() => setEditingBooking(null)} className="flex-1 py-3 rounded-xl border border-gray-700 text-gray-400 font-medium hover:bg-gray-800 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={() => {
                     if(!editBDate || !editBTime || editBDuration === '' || editBDuration === null || !editBName.trim() || !editBServices.trim()) {
                         return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –∏–º—è, –∑–æ–Ω—ã, –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!");
                     }
                     triggerHaptic();

                     const updatedB = { ...editingBooking, date: editBDate, time: editBTime, duration: editBDuration, clientName: editBName, services: editBServices };
                     
                     // –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï - –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ!
                     setBookingsList(prev => prev.map(b => b.id === updatedB.id ? updatedB : b));

                     if(db) db.collection("bookings").doc(updatedB.id).update({
                         date: editBDate, time: editBTime, duration: editBDuration, clientName: editBName, services: editBServices
                     });

                     const newDates = [...editData.dates];
                     if (editingBooking.date !== editBDate || editingBooking.time !== editBTime) {
                         const oldDIdx = newDates.findIndex(d => d.date === editingBooking.date);
                         if (oldDIdx !== -1 && !newDates[oldDIdx].slots.includes(editingBooking.time)) {
                             newDates[oldDIdx].slots.push(editingBooking.time);
                             newDates[oldDIdx].slots.sort();
                         }
                     }
                     
                     const newDIdx = newDates.findIndex(d => d.date === editBDate);
                     if (newDIdx !== -1) {
                         newDates[newDIdx].slots = removeOverlappingSlots(newDates[newDIdx].slots, editBTime, editBDuration);
                     }

                     const newData = {...editData, dates: newDates};
                     setEditData(newData);
                     setAppData(newData);
                     syncToFirebase(newData);
                     localStorage.setItem('electroAppData', JSON.stringify(newData));

                     setEditingBooking(null);
                     showToast("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! ‚úèÔ∏è");
                  }} className="flex-[2] py-3 rounded-xl bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black font-bold shadow-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'main' && selectedServices.length > 0 && (
            <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto animate-[slideInUp_0.3s_ease-out] z-50">
              <div className="bg-[#1A1A1A]/95 backdrop-blur-xl border-t border-x border-[#C89D7C]/30 rounded-t-3xl p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                <div className="mb-5">
                  <div className="flex justify-between items-end mb-4">
                    <div className="flex flex-col">
                      <span className="text-3xl font-bold text-[#C89D7C]">{selectedDuration} <span className="text-lg text-gray-400 font-medium">–º–∏–Ω</span></span>
                    </div>
                    <div className="flex flex-col items-end">
                      <span className="text-xs text-gray-500 mb-1">–ü—Ä–∏–º–µ—Ä–Ω–æ</span>
                      <span className="text-xl font-bold text-white">~ {totalPrice} ‚ÇΩ</span>
                    </div>
                  </div>
                  <input 
                    type="range" min="30" max="720" step="15" 
                    value={selectedDuration} 
                    onChange={(e) => setSelectedDuration(parseInt(e.target.value))}
                    className="w-full accent-[#C89D7C] h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer"
                    style={{ touchAction: 'none' }}
                  />
                  <div className="flex justify-between text-[10px] text-gray-500 mt-2 font-medium">
                    <span>30 –º–∏–Ω</span><span>3 —á</span><span>6 —á</span><span>12 —á</span>
                  </div>
                </div>
                <button onClick={() => { triggerHaptic(); setActiveTab('booking'); }} className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black p-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-bold text-lg">
                  –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É
                  <Icon name="ChevronLeft" className="w-5 h-5 rotate-180" />
                </button>
              </div>
            </div>
          )}

          {activeTab === 'booking' && selectedDate && selectedTime && (
             <div className="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto animate-[slideInUp_0.3s_ease-out] z-50">
             <button onClick={handlePreBooking} className="w-full bg-gradient-to-r from-[#C89D7C] to-[#9A6A45] text-black p-4 rounded-3xl shadow-[0_10px_40px_rgba(200,157,124,0.2)] flex items-center justify-center gap-2 font-bold text-lg">
               –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
             </button>
           </div>
          )}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>